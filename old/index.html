
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Установщик</title>
  <style>

    body { font-family: sans-serif; text-align: center; padding: 40px;  background-color: black;
  color: white; /* чтобы текст был виден */ }
    select, input, button { font-size: 18px; padding: 10px; margin: 10px; width: 250px; }
    #status { margin-top: 20px; font-weight: bold; min-height: 24px;  transition: opacity 0.5s ease;  opacity: 0;  position: fixed;  top: 10px;  left: 0;  right: 0;  text-align: center;  z-index: 1001; }
    #status.visible { opacity: 1; }
    .spin { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    select:focus, input:focus, button:focus { outline: none;
  box-shadow: 0 0 8px red;
  border-color: red; }
    .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .card {
  background-color: #2a2a2a;
  border-radius: 16px;
  padding: 20px;
  width: 80px;
  height: 62px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 13px;
  border: 2px solid transparent;
  transition: all 0.2s ease;
  cursor: pointer;
}

.card:hover,
.card:focus {
  background-color: #004d61;
  border-color: #00cfff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  outline: none;
}

.card.selected {
  background-color: #00cfff;
  color: black;
  border: 2px solid white;
}
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);
             display: flex; justify-content: center; align-items: center; z-index: 999; outline: none; }
    .modal-content { background: #111;  /* Очень тёмный фон, почти чёрный */
  color: white;       /* Текст белый, чтобы был виден */
  padding: 20px;
  border-radius: 10px;
  max-height: 80vh;
  overflow: hidden;   /* ← скролл только внутри #modalListContainer */
  width: 80%;
  border: 1px solid #333; /* Тонкая светлая рамка для отделения */ }
     #modalListContainer { max-height:60vh;
  overflow-y:auto;
  overscroll-behavior:contain;
  scroll-behavior:auto; /* ключевое — никакой плавности */
  scrollbar-gutter: stable both-edges;	}
    #modalList {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* Две колонки */
  gap: 10px;
  justify-items: center;
  
  
  
}
    
    /* СТИЛЬ КНОПОК В СТИЛЕ GOOGLE TV */
button {
  background-color: #004d61;
  color: white;
  border: 2px solid transparent; /* Прозрачная рамка — сразу резервируем место */
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 14px;
  width: 250px;
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
  box-sizing: border-box; /* Чтобы padding + border не раздували кнопку */
}

button:hover {
  background-color: #00cfff;
}

button:focus {
  outline: none;
  border-color: white; /* Белая рамка внутри зарезервированного места */
  box-shadow: 0 0 10px #004d61;
}

.system-buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 12px;
}

.sys-btn {
  flex: 1 1 calc(33.33% - 20px); /* до 3 кнопок в строку с отступами */
  min-width: 100px;
  max-width: 240px;
  padding: 10px;
  font-size: 13px;
  text-align: center;
  background-color: #004d61;
  color: white;
 border: 2px solid transparent; /* Прозрачная рамка — сразу резервируем место */
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.sys-btn:hover {
  background-color: #00cfff;
}

.sys-btn:focus {
  border-color: white; /* Белая рамка внутри зарезервированного места */
  box-shadow: 0 0 10px #004d61;
}
#splash {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}





#logo {
  position: fixed;       /* фиксируем поверх всего */
  top: 0;
  left: 0;
  width: 100vw;          /* на всю ширину экрана */
  height: 100vh;         /* на всю высоту экрана */
  background: url('https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/usr.gif') no-repeat center/contain;
  z-index: 9999;         /* поверх всех элементов */
}

/* Базовый стиль тоста */
.toast {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-sizing: border-box;
  background: rgba(0,0,0,0.85);
  color: #fff;
  border-radius: 10px;
  padding: 12px 18px;
  font-size: 14px;
  line-height: 1.3;
  max-width: min(70vw, 720px);
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  opacity: 0;
  transform: translateY(8px);
  transition: opacity .25s ease, transform .25s ease;
  pointer-events: auto;
}
.toast.show { opacity: 1; transform: translateY(0); }

/* Варианты формы */
.toast--pill    { border-radius: 999px; padding: 10px 16px; }
.toast--compact { padding: 8px 12px; font-size: 16px; }
.toast--card    { box-shadow: 0 8px 24px rgba(0,0,0,.35); }

/* Спин */
.toast .spin { display:inline-block; animation: spin 1s linear infinite; }
@keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }

/* Стеки по позициям (контейнеры) */
.toast-stack {
  position: fixed;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none; /* чтобы клики проходили сквозь стек */
}
.toast-stack--top    { top: 40px; }
.toast-stack--bottom { bottom: 40px; }
.toast-stack--center { top: 50%; transform: translateY(-50%); }

.toast-stack--left   { left: 40px; align-items: flex-start; }
.toast-stack--centerX{ left: 50%; transform: translateX(-50%); align-items: center; }
.toast-stack--right  { right: 40px; align-items: flex-end; }

/* Якорные тосты (позиционируются инлайново) */
.toast--anchored { position: fixed; z-index: 10000; }





  </style>
</head>




<body style="margin: 0; padding: 0;">
<div id="splash">
    <div id="logo"></div>
  </div>

  <div id="main-content" style="display:none;">
    <!-- здесь твой интерфейс: группы, кнопки и т.д. -->
  </div>
<h5 style="margin-top: 0;">Установщик ATV</h5>

<div id="progress-container" style="display:none; width: 100%; background: #000; padding: 5px; z-index: 1002; position: fixed; top: 0; left: 0; right: 0;">
  <div id="progress-text" style="color: white; margin-bottom: 5px;">Загрузка...</div>
  <div style="width: 100%; background: #000; height: 8px; border-radius: 6px;">
    <div id="progress-bar" style="height: 8px; width: 0%; background: #42A5F5; border-radius: 6px;"></div>
  </div>
</div>





<div class="card-container">
  <div class="card" data-group="1" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (65).png" alt="Старт" style="height: 28px;">Стартовый</div>
  
 <div class="card" data-group="2" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (4).svg" alt="YouTube" style="height: 23px;">YouTube</div>
  
  <div class="card" data-group="3" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (58).png" alt="Онлайн кинотеатры" style="height: 28px;">Онлайн кинотеатры</div>
  
  <div class="card" data-group="4" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (46).png" alt="4_Торрент" style="height: 28px;">Торрент + Кино</div>
  
  <div class="card" data-group="5" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (48).png" alt="IPTV" style="height: 27px;">IPTV</div>
  
  <div class="card" data-group="6" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (52).svg" alt="IPTV + TorrentTV" style="height: 28px;">IPTV + TorrentTV</div>
  <div class="card" data-group="7" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (67).png" alt="Полная настройка" style="height: 25px;">Полная настройка</div>
  
  <div class="card" data-group="8" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
  <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (64).png" alt="Заявки" style="height: 25px;">Заявки</div>
</div>
<script>
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('focus', () => {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      currentGroup = card.dataset.group;
    });
  });
   document.addEventListener('keydown', function (e) {
  // поддержим и NumpadEnter/OK на некоторых ТВ
  const isOk =
    e.key === 'Enter' ||
    e.key === 'NumpadEnter' ||
    e.key === 'OK' ||
    e.code === 'Enter';

  if (!isOk) return;
  if (anyModalOpen()) return; // если открыта модалка — ничего не делаем

  const selected = document.querySelector('.card.selected');
  if (!selected) return;

  // зафиксируем выбранную группу и сразу откроем
  currentGroup = selected.dataset.group;
  startInstall();
});


</script>
<select id="groupSelect" style="display:none;"></select>

<button type="button" id="startBtn" onclick="startInstall()">Открыть группу</button> 
<button type="button" id="passwordBtn">🔑 Введите пароль</button>
<div id="status"></div>
<!-- Кнопки системных настроек -->
<div class="system-buttons">
  <button onclick="event.stopPropagation();window.AndroidInterface.openUnknownSources()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (8).svg" alt="" style="height: 18px;"><br>Неизвестные источники
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAppSettingsList()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (42).png" alt="" style="height: 24px;"><br>Приложения
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAccessibilitySettings()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (44).png" alt="" style="height: 28px;"><br>Спец возможности
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openBatteryOptimization()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (34).png" alt="" style="height: 24px;"><br>Системные настройки
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAnydesk()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (12).svg" alt="" style="height: 24px;"><br>AnyDesk
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openPlayMarket()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (13).svg" alt="" style="height: 20px;"><br>Google Play
  </button>
 <button onclick="openAutostartModal()" class="sys-btn">
 <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (38).png" alt="" style="height: 28px;"><br>Автозагрузка приложения
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFileManagerPlus()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (15).svg" alt="" style="height: 26px;"><br>File Manager+
  </button>
   <button onclick="openMiscModal()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (19).png" alt="" style="height: 28px;"><br>Полезное
</div>





<div id="autostartModal" class="modal" style="display:none;">
  <div class="modal-content">
 
 <div id="autostartCurrent" style="margin-bottom: 10px; font-weight: bold;">
  Выбрано: Нет
</div>

    <h3>Выберите приложение для автозапуска:</h3>
	
	<button onclick="disableAutostart()" class="sys-btn">🚫 Отключить автозапуск</button>

    <div id="autostartList" class="card-container"></div>
    <button onclick="closeAutostartModal()" id="autostartCloseBtn">❌ Закрыть</button>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>


<div id="miscModal" class="modal" style="display: none;" tabindex="-1">
  <div class="modal-content">
    <h3>Разное</h3>
    <div class="system-buttons">
      <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFilePicker()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (15).svg" alt="" style="height: 26px;"><br>Файловый менеджер
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openSettingsForPackage('com.google.android.katniss')" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (6).svg" alt="" style="height: 24px;"><br>Google Katniss	
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAllAppsSide()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (11).svg" alt="" style="height: 24px;"><br>Меню приложений
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.deleteCopiedBackups()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (27).png" alt="" style="height: 28px;"><br>Удаление бэкапов
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.clearWebCache()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (20).png" alt="" style="height: 28px;"><br>Очистить кеш
  </button>
  <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAddAccountSettings()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без названия (40).png" alt="" style="height: 28px;"><br>Вход в аккаунт
  </button>
  
<button onclick="ignoreNextEnter=true;window.AndroidInterface.testAutostart()" class="sys-btn">🚀<br>Проверка автозапуска
</button>
  
    </div>
    <br>
    <button onclick="closeMiscModal()" class="sys-btn">Закрыть</button>
  </div>
</div>







<div id="modal" class="modal" style="display:none;">
   <div class="modal-content">
    <h3>Список компонентов:</h3>
    <div id="modalListContainer">
      <div id="modalList"></div>
    </div>
    <br>
    <button id="installAllBtn" onclick="installAll()">Установить всё</button>
    
  </div>
</div>

<script>
let currentGroup = "";
let cachedConfig = null;
let lastFocusedElement = null;

let lastPassword = "";


// 🔁 Очередь для последовательного копирования бэкапов
let backupQueue = [];
let backupTarget = "";
let savedPassword = "";

document.getElementById('passwordBtn').addEventListener('click', () => {
  const ai = window.AndroidInterface;

  // 1) Новый метод с префиллом
  if (ai?.requestPasswordPrefill) {
    ai.requestPasswordPrefill(savedPassword || "");
    return;
  }
  // 2) Или метод, принимающий аргумент (если так реализуешь)
  if (ai?.requestPassword) {
    // попробуем вызвать с аргументом; если не поддерживает — поймаем ошибку и вызовем без
    try {
      ai.requestPassword(savedPassword || "");
      return;
    } catch (e) {
      ai.requestPassword(); // старый без параметров
      return;
    }
  }

  // 3) Fallback: prompt в браузере/телефоне
  const pwd = prompt("Введите пароль", savedPassword || "");
  if (pwd !== null) {
    savedPassword = pwd.trim();
    updatePasswordBtn();
  }
});

// колбэк из Android — сюда вернём новое значение
function setPasswordFromAndroid(pwd) {
  savedPassword = (pwd || "").trim();
  updatePasswordBtn();
}

function updatePasswordBtn() {
  const btn = document.getElementById('passwordBtn');
  btn.textContent = savedPassword
    ? `🔑 Пароль: ${'*'.repeat(savedPassword.length)}`
    : "🔑 Введите пароль";
}

function anyModalOpen() {
  return ['modal','autostartModal','miscModal']
    .some(id => document.getElementById(id)?.style.display === 'flex');
}


// 🔁 Для пропууска ложного энтера
let ignoreNextEnter = false;


// ⏳ Старт копирования бэкапов по очереди
function copyBackupsSequentially(urls, folder) {
  if (!urls.length) return;

  backupQueue = urls;
  backupTarget = folder;
  copyNextBackup();
}

// 🚀 Следующий бэкап из очереди
function copyNextBackup() {
  if (backupQueue.length === 0) {
    showStatus("✅ Все бэкапы скопированы", "green");
    return;
  }

  const url = backupQueue.shift();
  const fileName = url.split('/').pop();
  showStatus(
  `⏳ Копирование: ${fileName} <span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без%20названия%20(45).png" style="height:29px; vertical-align:middle;"></span>`,
  "#00cfff",
  4000
);


  if (window.AndroidInterface) {
    window.AndroidInterface.copyBackup(url, backupTarget);
  }
}

// ⬅️ Вызывается из Android после завершения каждого бэкапа
function onBackupCopied() {
  copyNextBackup();
}


function selectCard(card) {
  // просто переключаем выбранную карточку
  document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');

  currentGroup = card.dataset.group;

  // очищаем статус
  document.getElementById('status').innerHTML = "";
  document.getElementById('status').classList.remove('visible');
}




async function startInstall() {
  const group = currentGroup;
  const password = savedPassword; // ← читаем из переменной
  const status = document.getElementById('status');

  if (!group) {
    status.innerHTML = "❗ Пожалуйста, выберите пакет.";
    status.style.color = "red";
    status.classList.add('visible');
    return;
  }

  try {
    const response = await fetch("https://f4iptv.github.io/Play/old/config.json");
    const config = await response.json();

    const groupInfo = config.groups[group];
    if (!groupInfo) {
      status.innerHTML = "❌ Группа не найдена!";
      status.style.color = "red";
      status.classList.add('visible');
      return;
    }

    if (groupInfo.password !== password) {
      
	  showToast({ message: "🔒 Неверный пароль!" });

      return;
    }

    cachedConfig = config;
    showGroupList(config);
  } catch (error) {
    status.innerHTML = "❌ Ошибка загрузки конфигурации.";
    status.style.color = "red";
    status.classList.add('visible');
  }
}


function showStatus(message, color, timeout = 4000) {
  const status = document.getElementById('status');
  status.innerHTML = message;
  status.style.color = color;
  status.classList.add('visible');

  clearTimeout(status.hideTimer); // если вызовов много — сброс старого таймера

  status.hideTimer = setTimeout(() => {
    status.classList.remove('visible');
  }, timeout);
}

// Создаёт/возвращает стек для позиции
function getToastStack(position = 'bottom-center') {
  const id = `toast-stack-${position}`;
  let stack = document.getElementById(id);
  if (stack) return stack;

  const [v, h] = position.split('-'); // top|center|bottom  +  left|center|right
  stack = document.createElement('div');
  stack.id = id;
  stack.className = `toast-stack toast-stack--${v} ${
    h === 'center' ? 'toast-stack--centerX' : (h === 'left' ? 'toast-stack--left' : 'toast-stack--right')
  } ${v === 'center' ? 'toast-stack--center' : ''}`;
  document.body.appendChild(stack);
  return stack;
}

/**
 * Показать тост
 * @param {Object} opts
 *  - message   : string              текст
 *  - type      : "info"|"success"|"error"|"warning"|... (цвета ниже)
 *  - iconUrl   : string|null         иконка слева (например, app.icon)
 *  - withSpin  : boolean             показать ⏳
 *  - position  : "bottom-center"|"top-right"|... или anchor
 *  - variant   : "default"|"pill"|"compact"|"card" (форма)
 *  - duration  : number              мс до скрытия (по умолчанию 3000)
 *  - anchor    : Element|Selector    привязать к DOM-элементу
 *  - offset    : number              отступ при anchor (по умолчанию 10)
 *  - colors    : {bg,text}           переопределить цвета прямо вызовом (необязательно)
 */
function showToast({
  message,
  type = "info",
  iconUrl = null,
  withSpin = false,
  position = "bottom-center",
  variant = "default",
  duration = 3000,
  anchor = null,
  offset = 10,
  colors = null
}) {
  if (!message) return;

  // Цветовые схемы (фон + шрифт). Добавляй свои сколько угодно.
  const styles = {
    success: { bg: "rgba(0,128,0,0.85)",  text: "#fff" },
    error:   { bg: "rgba(220,0,0,0.9)",   text: "#fff" },
    warning: { bg: "rgba(255,165,0,0.9)", text: "#000" },
    info:    { bg: "rgba(242,0,0,0.85)",    text: "#fff" },
    blue:    { bg: "rgba(0,123,255,0.9)", text: "#fff" },
    pink:    { bg: "rgba(255,105,180,0.9)", text: "#000" }
  };
  const scheme = colors || styles[type] || styles.info;

  // Элемент тоста
  const toast = document.createElement('div');
  toast.className = 'toast' +
    (variant === 'pill'    ? ' toast--pill'    : '') +
    (variant === 'compact' ? ' toast--compact' : '') +
    (variant === 'card'    ? ' toast--card'    : '');

  toast.style.backgroundColor = scheme.bg;
  toast.style.color = scheme.text;

  // Контент
  let html = '';
  if (iconUrl) {
    html += `<img src="${iconUrl}" alt="" style="height:20px; width:20px; object-fit:contain; vertical-align:middle;">`;
  }
  if (withSpin) {
    html += `<span class="spin">⏳</span>`;
  }
  html += `<span>${message}</span>`;
  toast.innerHTML = html;

  // Размещение
  let cleanup;
  if (anchor) {
    // Якорный режим — рядом с элементом
    const el = typeof anchor === 'string' ? document.querySelector(anchor) : anchor;
    const rect = el?.getBoundingClientRect();
    toast.classList.add('toast--anchored');
    document.body.appendChild(toast);

    // По умолчанию — под элементом по центру
    const top = (rect?.bottom ?? 0) + offset;
    const left = (rect ? rect.left + rect.width / 2 : window.innerWidth / 2);
    toast.style.top = `${top}px`;
    toast.style.left = `${left}px`;
    toast.style.transform = 'translateX(-50%)';
    cleanup = () => toast.remove();
  } else {
    // Стековый режим — по позиции
    const stack = getToastStack(position);
    stack.appendChild(toast);
    cleanup = () => {
      toast.remove();
      // автоудаление пустого стека
      if (!stack.children.length) stack.remove();
    };
  }

  // Плавное появление
  requestAnimationFrame(() => toast.classList.add('show'));

  // Автоскрытие
  const hide = () => {
    toast.classList.remove('show');
    setTimeout(cleanup, 250);
  };
  const timer = setTimeout(hide, duration);

  // Закрытие по клику
  toast.addEventListener('click', () => {
    clearTimeout(timer);
    hide();
  });
}





// ===== Список группы =====
function showGroupList(config)  {
  const modal = document.getElementById('modal');
  const list = document.getElementById('modalList');
  list.innerHTML = "";

  const apps    = config.apps.filter(app => app.tags.includes(currentGroup));
  const backups = config.backups.filter(backup => backup.tags.includes(currentGroup));
  const links   = (config.links || []).filter(link => link.tags.includes(currentGroup));

  if (apps.length === 0 && backups.length === 0 && links.length === 0) {
    list.innerHTML = "Нет доступных компонентов.";
  }

  // --- apps
  apps.forEach(app => {
    const btn = document.createElement('button');
    btn.className = 'component-btn';
    btn.setAttribute('tabindex','0');
    btn.textContent = app.file;
    btn.onclick = () => {
      showStatus(
        `Загрузка APK...<span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без%20названия%20(45).png" style="height:29px; vertical-align:middle;"></span>`,
        "#00cfff", 4000
      );
      window.AndroidInterface?.installSingle(app.url, app.file || "Приложение");
    };
    list.appendChild(btn);
  });

  // --- backups
  backups.forEach(backup => {
    const btn = document.createElement('button');
    btn.className = 'component-btn';
    btn.setAttribute('tabindex','0');
    btn.textContent = backup.file;
    btn.onclick = () => {
      const urls = backup.urls || (backup.url ? [backup.url] : []);
      if (!urls.length) return;
      showStatus(
        `Копирование бэкапов... <span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без%20названия%20(45).png" style="height:29px; vertical-align:middle;"></span>`,
        "#00cfff", 4000
      );
      window.AndroidInterface?.copyMultipleBackups(JSON.stringify(urls), backup.target_folder);
    };
    list.appendChild(btn);
  });

  // --- links
  links.forEach(link => {
    const btn = document.createElement('button');
    btn.className = 'component-btn';
    btn.setAttribute('tabindex','0');
    btn.textContent = link.file;
    btn.onclick = () => {
      showStatus("🔗 Открытие инструкции...", "green", 3000);
      window.AndroidInterface?.openLink(link.url);
    };
    list.appendChild(btn);
  });

  // показать модалку
   modal.style.display = "flex";

  // важный момент: ставим фокус на первую кнопку без автоскролла
  setTimeout(() => {
    document.querySelector('#modalList .component-btn')
      ?.focus({ preventScroll: true });
  }, 80);
}


function installAll() {
  showStatus(
    `Началась загрузка приложений, ожидайте...<span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/Без%20названия%20(45).png" style="height:29px; vertical-align:middle;"></span>`,
    "#00cfff", 4000
  );
  if (window.AndroidInterface) {
    requestAnimationFrame(() => {
      setTimeout(() => {
        window.AndroidInterface.startInstallation(currentGroup);
      }, 100);
    });
  }
}

function closeModal() {
  document.getElementById('modal').style.display = "none";
}

// ===== ЕДИНСТВЕННЫЙ обработчик стрелок для #modal =====
// УДАЛИ или закомментируй свои старые обработчики для #modal (те где allButtons/extraButtons)!
// Навигация в модалке групп (#modal)
(function () {
  const modal     = document.getElementById('modal');
  const list      = document.getElementById('modalList');
  const container = document.getElementById('modalListContainer');
  const cols = 2;          // у тебя сетка 2 колонки
  let navLock = false;     // лёгкий троттлинг от key-repeat

  // Докрутка контейнера ровно до видимости элемента (без дерганья)
  function ensureVisible(el, margin = 12) {
    if (!el || !container) return;
    const cr = container.getBoundingClientRect();
    const er = el.getBoundingClientRect();

    if (er.top < cr.top + margin) {
      container.scrollTop -= (cr.top + margin - er.top);
    } else if (er.bottom > cr.bottom - margin) {
      container.scrollTop += (er.bottom - (cr.bottom - margin));
    }
  }

  function focusAndReveal(el, margin = 12) {
  if (!el || !container) return;

  // 1. Фокусируем БЕЗ автоскролла
  el.focus({ preventScroll: true });

  // 2. Сами решаем, как докрутить контейнер
  const cr = container.getBoundingClientRect();
  const er = el.getBoundingClientRect();

  if (er.top < cr.top + margin) {
    // элемент слишком высоко — поднимаем контейнер
    container.scrollTop -= (cr.top + margin - er.top);
  } else if (er.bottom > cr.bottom - margin) {
    // элемент слишком низко — опускаем контейнер
    container.scrollTop += (er.bottom - (cr.bottom - margin));
  }
}

  document.addEventListener('keydown', (e) => {
    // работаем только если модалка групп открыта
    if (modal.style.display !== 'flex') return;

    // интересуют стрелки + Enter
    const keys = ['ArrowDown','ArrowUp','ArrowLeft','ArrowRight','Enter'];
    if (!keys.includes(e.key)) return;

    // блокируем авто-повтор, иначе будет «след»
    if (e.repeat) { e.preventDefault(); return; }

    // навигация — только по кнопкам внутри списка
    const buttons = Array.from(list.querySelectorAll('.component-btn'));
    if (!buttons.length) return;

    const active = document.activeElement;
    let index = buttons.indexOf(active);

    // если фокуса ещё не было — ставим на первую
    if (index === -1) {
      e.preventDefault();
      return focusAndReveal(buttons[0]);
    }

    e.preventDefault();
    e.stopPropagation();

    // Enter нажимает активную кнопку
    if (e.key === 'Enter') {
      active?.click();
      return;
    }

    // лёгкий троттлинг от «ручья» keydown с пульта
    if (navLock) return;
    navLock = true;
    setTimeout(() => (navLock = false), 90);

    let next = index;

    if (e.key === 'ArrowDown') {
      if (index + cols < buttons.length) {
        next = index + cols;
        return focusAndReveal(buttons[next]);
      } else {
        // низ списка — уводим фокус на «Установить всё», если она есть
        document.getElementById('installAllBtn')
          ?.focus({ preventScroll: true });
        return;
      }
    }

    if (e.key === 'ArrowUp') {
      if (index - cols >= 0) next = index - cols;
      return focusAndReveal(buttons[next]);
    }

    if (e.key === 'ArrowRight') {
      if ((index % cols) < (cols - 1) && index + 1 < buttons.length) {
        next = index + 1;
        return focusAndReveal(buttons[next]);
      }
      return;
    }

    if (e.key === 'ArrowLeft') {
      if ((index % cols) > 0) {
        next = index - 1;
        return focusAndReveal(buttons[next]);
      }
      return;
    }
  });
})();



</script>


<script>
  function handleBackButton() {
  if (document.getElementById('miscModal')?.style.display === 'flex') {
    closeMiscModal();
  } else if (document.getElementById('autostartModal')?.style.display === 'flex') {
    closeAutostartModal();
  } else if (document.getElementById('modal')?.style.display === 'flex') {
    closeModal();
  } else {
    window.AndroidInterface.requestAppExit(); // ← вызывает двойной выход
  }
}

</script>



<script>
  // 📺 Скрываем кнопку "Открыть группу" на Android TV / Google TV
  const isTV = /TV|AFT|GoogleTV|SHIELD/i.test(navigator.userAgent);
  if (isTV) {
    const startBtn = document.getElementById("startBtn");
    if (startBtn) startBtn.style.display = "none";
  }
</script>


</body>
</html>

<script>
function updateProgress(current = null, total = null, percent = 0, label) {
  const container = document.getElementById("progress-container");
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("progress-text");

  container.style.display = "block";
  bar.style.width = percent + "%";

  if (current !== null && total !== null) {
    text.innerHTML = `Загрузка приложения:&nbsp;&nbsp; ${label}&nbsp;&nbsp;&nbsp;&nbsp;${percent}%`;
  } else {
    text.innerText = `Загрузка...`;
  }

  if (percent >= 100 && (current === null || current === total)) {
    setTimeout(() => {
      container.style.display = "none";
      bar.style.width = "0%";
      text.innerHTML = "";
    }, 1500);
  }
}

</script>
<script>
function updateProgressWithLabel(current, total, percent, label) {
  const container = document.getElementById("progress-container");
  const bar = document.getElementById("progress-bar");
  const text = document.getElementById("progress-text");

  container.style.display = "block";
  bar.style.width = percent + "%";
  text.innerText = `Загрузка ${label}: ${percent}%`;

  if (percent >= 100 && current === total) {
    setTimeout(() => {
      container.style.display = "none";
      bar.style.width = "0%";
      text.innerText = "";
    }, 1500);
  }
}
</script>
<script>
function openAutostartModal() {
lastFocusedElement = document.activeElement; // 💾 запоминаем, что было в фокусе
  const modal = document.getElementById('autostartModal');
  const list = document.getElementById('autostartList');

  // Очистка текущего блока перед обновлением
  const current = document.getElementById('autostartCurrent');
  current.innerHTML = '<span style="color: #00cfff;">Без автозапуска</span>';

  // Запрос текущего выбранного приложения
  if (window.AndroidInterface) {
    window.AndroidInterface.getCurrentAutostartApp();
  }

  modal.style.display = 'flex';
  list.innerHTML = '<div style="grid-column: span 2;">⏳ Загрузка...</div>';

  if (window.AndroidInterface) {
    window.AndroidInterface.getUserApps();
  }

  // Фокусировка первого элемента
  setTimeout(() => {
    const first = list.querySelector('.card, button');
    if (first) {
      first.focus();
    } else {
      modal.setAttribute('tabindex', '-1');
      modal.focus();
    }
  }, 400);
}

function setCurrentAutostartApp(appLabel, appIcon) {
  const current = document.getElementById("autostartCurrent");
  current.innerHTML = `
  <span style="font-weight: bold; color: #00cfff;">Активное:</span>
  <img src="${appIcon}" alt="" style="height: 24px; vertical-align: middle; margin: 0 6px;">
  <span style="font-weight: bold;">${appLabel}</span>
`;

}


function closeAutostartModal() {
  document.getElementById('autostartModal').style.display = 'none';
 // ⬅️ Возврат фокуса
  if (lastFocusedElement && document.body.contains(lastFocusedElement)) {
    lastFocusedElement.focus();
  }
}

function renderAppSelection(json) {
  const apps = JSON.parse(json);
  const list = document.getElementById('autostartList');
  list.innerHTML = '';

  apps.forEach(app => {
    const card = document.createElement('div');
    card.className = 'card';
    card.setAttribute('tabindex', '0');
    card.innerHTML = `<img src="${app.icon}" alt="" style="height:24px;"><br>${app.label}`;
    card.onclick = (ev) => {
      ev.preventDefault();
	  ev.stopPropagation();
      window.AndroidInterface.saveAutostartPackage(app.package);
      setCurrentAutostartApp(app.label, app.icon);
      showToast({
  message: `${app.label} установлено как автозапуск`,
  iconUrl: app.icon,
  type: "success"
});


    };
    card.onfocus = () => {
      document.querySelectorAll('#autostartList .card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      document.getElementById("autostartCurrent").textContent = "Выбрано: " + applabel;
    };
    list.appendChild(card);
  });

  setTimeout(() => {
    const first = list.querySelector('.card');
    if (first) first.focus();
  }, 100);
}

function disableAutostart() {
  if (window.AndroidInterface) {
    window.AndroidInterface.DeleteAutostartPackage(""); // или null
    // Обновляем статус на экране
    const current = document.getElementById('autostartCurrent');
    if (current) {
      current.innerHTML = '<span style="color: #00cfff;">Автозапуск отключён</span>';
    }
    showToast({ message: "Автозапуск отключён" });
  }
}




</script>
<script>
function hideProgress() {
  const container = document.getElementById('progress-container');
  const bar = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');

  if (container) container.style.display = 'none';
  if (bar) bar.style.width = '0%';
  if (text) text.innerText = '';
}



function onInstalledAppsReceived(appsJson) {
  const container = document.getElementById('appList');
  container.innerHTML = ''; // очистка "Загрузка..."

  let apps;
  try {
    apps = JSON.parse(appsJson);
  } catch (e) {
    container.innerHTML = 'Ошибка чтения списка.';
    return;
  }

  apps.forEach(app => {
    const btn = document.createElement('button');
    btn.textContent = `${app.name} (${app.package})`;
    btn.onclick = () => {
      window.AndroidInterface.setAutostartPackage(app.package);
      alert("Установлено: " + app.name);
      closeAutostartModal();
    };
    container.appendChild(btn);
    container.appendChild(document.createElement('br'));
  });
}
</script>


<script>
  // Убираем выделение с группы, если фокус на системной кнопке
  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("focus", () => {
      if (!btn.classList.contains("card")) {
        document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
      }
    });
  });
</script>
<script>
  setTimeout(() => {
    document.getElementById('splash').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
  }, 3000); // 3 секунды
</script>

<script>
document.addEventListener('keydown', function (e) {
  const modal = document.getElementById('autostartModal');
  if (!modal || modal.style.display !== 'flex') return;
  
  e.stopPropagation();
  e.stopImmediatePropagation();

  const cards = Array.from(document.querySelectorAll('#autostartList .card'));
  const closeBtn = document.getElementById('autostartCloseBtn');
  if (!cards.length) return;

  const cols = 5;
  const active = document.activeElement;
  const index = cards.indexOf(active);

  // если фокус на кнопке "Закрыть", позволим только вверх и Escape
  if (active === closeBtn) {
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      const lastRowStart = Math.floor((cards.length - 1) / cols) * cols;
      cards[cards.length - 1].focus(); // на последнюю карточку
    } else if (e.key === 'Back' || e.key === 'Escape') {
      e.preventDefault();
      closeAutostartModal();
    }
    return;
  }

  const total = cards.length;
  const row = Math.floor(index / cols);
  const col = index % cols;

  switch (e.key) {
    case 'ArrowDown':
      e.preventDefault();
      const nextIndex = (row + 1) * cols + col;
      if (nextIndex < total) {
        cards[nextIndex].focus();
      } else {
        // если это последний ряд — фокус на кнопку "Закрыть"
        closeBtn?.focus();
      }
      break;

    case 'ArrowUp':
      e.preventDefault();
      const prevIndex = (row - 1) * cols + col;
      if (prevIndex >= 0) {
        cards[prevIndex].focus();
      }
      break;

    case 'ArrowLeft':
      e.preventDefault();
      if (index > 0) cards[index - 1].focus();
      break;

    case 'ArrowRight':
      e.preventDefault();
      if (index < total - 1) cards[index + 1].focus();
      break;

    case 'Enter':
      e.preventDefault();
      active.click();
      break;

    case 'Back':
    case 'Escape':
      e.preventDefault();
      closeAutostartModal()

</script>

<script>
document.addEventListener('keydown', function (e) {
  const modal = document.getElementById('miscModal');
  if (!modal || modal.style.display !== 'flex') return;

  const cards = Array.from(document.querySelectorAll('#autostartList .card'));
  const closeBtn = document.getElementById('autostartCloseBtn');
  if (!cards.length) return;

  const cols = 5;
  const active = document.activeElement;
  const index = cards.indexOf(active);

  // если фокус на кнопке "Закрыть", позволим только вверх и Escape
  if (active === closeBtn) {
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      const lastRowStart = Math.floor((cards.length - 1) / cols) * cols;
      cards[cards.length - 1].focus(); // на последнюю карточку
    } else if (e.key === 'Back' || e.key === 'Escape') {
      e.preventDefault();
      closeAutostartModal();
    }
    return;
  }

  const total = cards.length;
  const row = Math.floor(index / cols);
  const col = index % cols;

  switch (e.key) {
    case 'ArrowDown':
      e.preventDefault();
      const nextIndex = (row + 1) * cols + col;
      if (nextIndex < total) {
        cards[nextIndex].focus();
      } else {
        // если это последний ряд — фокус на кнопку "Закрыть"
        closeBtn?.focus();
      }
      break;

    case 'ArrowUp':
      e.preventDefault();
      const prevIndex = (row - 1) * cols + col;
      if (prevIndex >= 0) {
        cards[prevIndex].focus();
      }
      break;

    case 'ArrowLeft':
      e.preventDefault();
      if (index > 0) cards[index - 1].focus();
      break;

    case 'ArrowRight':
      e.preventDefault();
      if (index < total - 1) cards[index + 1].focus();
      break;

    case 'Enter':
      e.preventDefault();
      active.click();
      break;

    case 'Back':
    case 'Escape':
      e.preventDefault();
      closeMiscModal()

</script>


<script>
  function openMiscModal() {
  lastFocusedElement = document.activeElement; // 💾 запоминаем, что было в фокусе
  const modal = document.getElementById("miscModal");
  modal.style.display = "flex";
  document.body.classList.add("modal-open");

  // Принудительно снимаем фокус с любого текущего
  document.activeElement?.blur();

  const firstBtn = modal.querySelector('.sys-btn');
  if (firstBtn) {
    setTimeout(() => firstBtn.focus(), 100);
  } else {
    // Если нет фокусируемых — ставим на саму модалку
    modal.focus();
  }
}



  function closeMiscModal() {
   const modal = document.getElementById("miscModal");
  modal.style.display = "none";
  document.body.classList.remove("modal-open");
  // ⬅️ Возврат фокуса
  setTimeout(() => {
    if (lastFocusedElement && document.body.contains(lastFocusedElement)) {
      lastFocusedElement.focus?.();
    }
    lastFocusedElement = null; // очистка ссылки
  }, 50);
}
  
</script>



</body>
</html>
