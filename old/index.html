
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; background-color: #000; color: #fff; }
    select, input, button { font-size: 18px; padding: 10px; margin: 10px; width: 250px; }
    #status { margin-top: 20px; font-weight: bold; min-height: 24px; transition: opacity .5s ease; opacity: 0; position: fixed; top: 10px; left: 0; right: 0; text-align: center; z-index: 1001; }
    #status.visible { opacity: 1; }
    .spin { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    select:focus, input:focus, button:focus { outline: none; box-shadow: 0 0 8px red; border-color: red; }

    .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .card {
      background-color: #2a2a2a; border-radius: 16px; padding: 20px;
      width: 80px; height: 62px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #fff; font-size: 13px; border: 2px solid transparent; transition: all .2s ease; cursor: pointer;
    }
    .card:hover, .card:focus { background-color: #004d61; border-color: #00cfff; box-shadow: 0 0 10px rgba(0,0,0,.5); outline: none; }
    .card.selected { background-color: #00cfff; color: #000; border: 2px solid #fff; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; justify-content: center; align-items: center; z-index: 999; outline: none; }
    .modal-content {
      background: #111; color: #fff; padding: 20px; border-radius: 10px;
      max-height: 80vh; overflow: hidden; width: 80%; border: 1px solid #333;
    }

    /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ "–†–∞–∑–Ω–æ–µ" */
    #miscModal .modal-content {
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }

    #miscModal .misc-buttons-container {
      max-height: 60vh;
      overflow-y: auto;
      overscroll-behavior: contain;
      scroll-behavior: auto;
      scrollbar-gutter: stable both-edges;
      margin-bottom: 20px;
    }

    body.modal-open { overflow: hidden; }

    /* –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ –≥—Ä—É–ø–ø */
    #modalListContainer { max-height: 60vh; overflow-y: auto; overscroll-behavior: contain; scroll-behavior: auto; scrollbar-gutter: stable both-edges; }
    #modalList { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; justify-items: center; }
    #modalList .component-btn { transition: none !important; }
    #modalList .component-btn:focus { box-shadow: 0 0 0 3px rgba(255,255,255,.6) !important; border-color: #fff !important; outline: none; }

    /* –ö–Ω–æ–ø–∫–∏ –≤ —Å—Ç–∏–ª–µ Google TV */
    button {
      background-color: #004d61; color: #fff; border: 2px solid transparent; border-radius: 8px;
      padding: 10px 20px; font-size: 14px; width: 250px; cursor: pointer;
      transition: background-color .2s ease, box-shadow .2s ease, border-color .2s ease; box-sizing: border-box;
    }
    button:hover { background-color: #00cfff; }
    button:focus { outline: none; border-color: #fff; box-shadow: 0 0 10px #004d61; }

    .system-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 12px; }
    .sys-btn {
      flex: 1 1 calc(33.33% - 20px); min-width: 100px; max-width: 240px; padding: 10px; font-size: 13px; text-align: center;
      background-color: #004d61; color: #fff; border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: background-color .3s ease;
    }
    .sys-btn:hover { background-color: #00cfff; }
    .sys-btn:focus { border-color: #fff; box-shadow: 0 0 10px #004d61; }

    #splash { position: fixed; inset: 0; background-color: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    #logo { position: fixed; inset: 0; background: url('https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/usr.gif') no-repeat center/contain; z-index: 9999; }

    /* –¢–æ—Å—Ç—ã */
    .toast {
      display: inline-flex; align-items: center; gap: 8px; box-sizing: border-box; background: rgba(0,0,0,.85); color: #fff;
      border-radius: 10px; padding: 12px 18px; font-size: 14px; line-height: 1.3; max-width: min(70vw,720px);
      white-space: normal; overflow-wrap: anywhere; word-break: break-word; opacity: 0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease; pointer-events: auto;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast--pill { border-radius: 999px; padding: 10px 16px; }
    .toast--compact { padding: 8px 12px; font-size: 16px; }
    .toast--card { box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .toast .spin { display:inline-block; animation: spin 1s linear infinite; }
    .toast-stack { position: fixed; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast-stack--top{ top: 40px; } .toast-stack--bottom{ bottom: 40px; } .toast-stack--center{ top: 50%; transform: translateY(-50%); }
    .toast-stack--left{ left: 40px; align-items: flex-start; } .toast-stack--centerX{ left: 50%; transform: translateX(-50%); align-items: center; }
    .toast-stack--right{ right: 40px; align-items: flex-end; }
    .toast--anchored { position: fixed; z-index: 10000; }

    /* === –ê–í–¢–û–ó–ê–ü–£–°–ö === */
    #autostartListContainer { max-height: 60vh; overflow-y: auto; overscroll-behavior: contain; scroll-behavior: auto; scrollbar-gutter: stable both-edges; }
    #autostartList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –ø–æ —à–∏—Ä–∏–Ω–µ –º–æ–¥–∞–ª–∫–∏ */
      gap: 10px;
      justify-items: center;
    }
    #autostartList .card { transition: none !important; }
    #autostartList .card:focus { box-shadow: 0 0 0 3px rgba(255,255,255,.6) !important; border-color: #fff !important; outline: none; }

    /* –°–¥–µ–ª–∞–µ–º ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª –≤–∏–¥–∏–º–æ–π –∫–∞–∫ "–Ω–∏–∑ —Å–ø–∏—Å–∫–∞" */
    #autostartCloseBtn { margin: 12px auto 0; width: 100%; max-width: 320px; }


     /* –ö—Ä–∞—Å–∏–º –∏–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è*/
  .app-name {
    color: #00cfff;       /* –æ—Ç—Ç–µ–Ω–æ–∫ –±–∏—Ä—é–∑–æ–≤–æ–≥–æ, –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
    font-weight: 700;
  }

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–∞–∫ –º–æ–¥–∞–ª–∫–∞ "–†–∞–∑–Ω–æ–µ") */
#installMethodModal {
  z-index: 1000 !important; /* –í—ã—à–µ —á–µ–º —É –º–æ–¥–∞–ª–∫–∏ "–†–∞–∑–Ω–æ–µ" (999) */
}

#installMethodModal .modal-content {
  display: flex;
  flex-direction: column;
  max-height: 80vh;
}

#installMethodModal .sys-btn {
  width: 100%;
  max-width: 320px;
  margin: 0 auto;
}

#installMethodModal .method-option {
  margin: 10px 0;
  padding: 10px;
  border: 2px solid #333;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: flex-start;
  gap: 5px;
  position: relative;
}
/* –£–ø–ª–æ—Ç–Ω—è–µ–º –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ä–∞–¥–∏–æ-–æ–ø—Ü–∏–∏ */
#installMethodModal .install-method-settings{
  max-width: 560px;         /* —Å–ø–∏—Å–æ–∫ —É–∂–µ, –Ω–µ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
  margin: 0 auto;
}

#installMethodModal .method-option:hover {
  border-color: #007bff;
  background-color: rgba(0, 123, 255, 0.1);
}

#installMethodModal .method-option.selected {
  border-color: #007bff;
  background-color: rgba(0, 123, 255, 0.1);
}

#installMethodModal .method-option:focus {
  border-color: #00cfff;
  background-color: rgba(0, 207, 255, 0.1);
  outline: none;
}

#installMethodModal .method-option input[type="radio"] {
  margin: 0;
  transform: scale(1.2);
  flex-shrink: 0;
}

#installMethodModal .method-option label {
  cursor: pointer;
  display: block;
  margin: 0;
  flex: 1;
}

    
    
  </style>
</head>

<body style="margin:0; padding:0;">
  <div id="splash"><div id="logo"></div></div>
  <div id="main-content" style="display:none;"></div>

  <h5 style="margin-top:0;">–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ ATV</h5>

  <div id="progress-container" style="display:none; width:100%; background:#000; padding:5px; z-index:1002; position:fixed; bottom:0; left:0; right:0;">
    <div id="progress-text" style="color:#fff; margin-bottom:5px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div style="width:100%; background:#000; height:8px; border-radius:6px;">
      <div id="progress-bar" style="height:8px; width:0%; background:#42A5F5; border-radius:6px;"></div>
    </div>
  </div>

  <div class="card-container" id="groupCards"></div>

  <script>
    // Enter/OK –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
    document.addEventListener('keydown', function (e) {
      const isOk = e.key === 'Enter' || e.key === 'NumpadEnter' || e.key === 'OK' || e.code === 'Enter';
      if (!isOk) return;
      if (anyModalOpen()) return;

      const selected = document.querySelector('.card.selected');
      if (!selected) return;
      currentGroup = selected.dataset.group;
      startInstall();
    });
  </script>

  <select id="groupSelect" style="display:none;"></select>
  <button type="button" id="startBtn" onclick="startInstall()">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
  <button type="button" id="passwordBtn">üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</button>
  <div id="status"></div>

  <div class="system-buttons">
    <button onclick="event.stopPropagation();window.AndroidInterface.openUnknownSources()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (8).svg" alt="" style="height:18px;"><br>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAppSettingsList()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (42).png" alt="" style="height:24px;"><br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAccessibilitySettings()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (44).png" alt="" style="height:28px;"><br>–°–ø–µ—Ü –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openBatteryOptimization()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (34).png" alt="" style="height:24px;"><br>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAnydesk()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (12).svg" alt="" style="height:24px;"><br>AnyDesk
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openPlayMarket()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (13).svg" alt="" style="height:20px;"><br>Google Play
    </button>
    <button onclick="openAutostartModal()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (38).png" alt="" style="height:28px;"><br>–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFileManagerPlus()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (15).svg" alt="" style="height:26px;"><br>File Manager+
    </button>
    <button onclick="openMiscModal()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (19).png" alt="" style="height:28px;"><br>–ü–æ–ª–µ–∑–Ω–æ–µ
    </button>
    <button onclick="AndroidInterface.updateWebView()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (19).png" alt="" style="height:28px;"><br>–û–±–Ω–æ–≤–∏—Ç—å Webview
    </button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ -->
  <div id="autostartModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div id="autostartCurrent" style="margin-bottom:10px; font-weight:bold;">–í—ã–±—Ä–∞–Ω–æ: –ù–µ—Ç</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞:</h3>
      <button onclick="disableAutostart()" class="sys-btn">üö´ –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫</button>
      <button onclick="ignoreNextEnter=true;window.AndroidInterface.testAutostart()" class="sys-btn">üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</button>

      <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –°–û –°–ö–†–û–õ–õ–û–ú (–∏ –∑–¥–µ—Å—å –∂–µ –∫–Ω–æ–ø–∫–∞ –ó–∞–∫—Ä—ã—Ç—å) -->
      <div id="autostartListContainer">
        <div id="autostartList"></div>
        <button id="autostartCloseBtn" onclick="closeAutostartModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–†–∞–∑–Ω–æ–µ¬ª -->
  <div id="miscModal" class="modal" style="display:none;" tabindex="-1">
    <div class="modal-content">
      <h3>–†–∞–∑–Ω–æ–µ</h3>
      <div class="misc-buttons-container">
        <div class="system-buttons">
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFilePicker()" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (15).svg" alt="" style="height:26px;"><br>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openSettingsForPackage('com.google.android.katniss')" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (6).svg" alt="" style="height:24px;"><br>Google Katniss
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAllAppsSide()" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (11).svg" alt="" style="height:24px;"><br>–ú–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.deleteCopiedBackups()" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (27).png" alt="" style="height:28px;"><br>–£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.clearWebCache()" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (20).png" alt="" style="height:28px;"><br>–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAddAccountSettings()" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (40).png" alt="" style="height:28px;"><br>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openApkFilePicker()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(15).svg" alt="" style="height:26px;"><br>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å APK
  </button>
  <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
  <button onclick="showInstallMethodSettings()" class="sys-btn">
    <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(15).svg" alt="" style="height:26px;"><br>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.openSettingsForPackage('com.android.tv.frameworkpackagestubs')" class="sys-btn">
            <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (6).svg" alt="" style="height:24px;"><br> Activity Stub
          </button>
          <button onclick="ignoreNextEnter=true;window.AndroidInterface.testAutostart()" class="sys-btn">üöÄ<br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:</h3>
      <div id="modalListContainer"><div id="modalList"></div></div>
      <br>
      <button id="installAllBtn" onclick="installAll()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë</button>
    </div>
  </div>

  <script>
    let currentGroup = "";
    let cachedConfig = null;
    let lastFocusedElement = null;
    let lastPassword = "";
    let backupQueue = [];
    let backupTarget = "";
    let savedPassword = "";
    let ignoreNextEnter = false;

    document.getElementById('passwordBtn').addEventListener('click', () => {
      const ai = window.AndroidInterface;
      if (ai?.requestPasswordPrefill) { ai.requestPasswordPrefill(savedPassword || ""); return; }
      if (ai?.requestPassword) { try { ai.requestPassword(savedPassword || ""); return; } catch (e) { ai.requestPassword(); return; } }
      const pwd = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", savedPassword || "");
      if (pwd !== null) { savedPassword = pwd.trim(); updatePasswordBtn(); }
    });

    function setPasswordFromAndroid(pwd) { savedPassword = (pwd || "").trim(); updatePasswordBtn(); }
    function updatePasswordBtn() {
      const btn = document.getElementById('passwordBtn');
      btn.textContent = savedPassword ? `üîë –ü–∞—Ä–æ–ª—å: ${'*'.repeat(savedPassword.length)}` : "üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å";
    }
    function anyModalOpen() { return ['modal','autostartModal','miscModal','installMethodModal'].some(id => document.getElementById(id)?.style.display === 'flex'); }

    function copyBackupsSequentially(urls, folder) { if (!urls.length) return; backupQueue = urls; backupTarget = folder; copyNextBackup(); }
    function copyNextBackup() {
      if (backupQueue.length === 0) { showStatus("‚úÖ –í—Å–µ –±—ç–∫–∞–ø—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã", "green"); return; }
      const url = backupQueue.shift(); const fileName = url.split('/').pop();
      showStatus(`‚è≥ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: ${fileName} <span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(45).png" style="height:29px; vertical-align:middle;"></span>`, "#00cfff", 4000);
      window.AndroidInterface?.copyBackup(url, backupTarget);
    }
    function onBackupCopied() { copyNextBackup(); }

    function selectCard(card) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      currentGroup = card.dataset.group;
      const s = document.getElementById('status'); s.innerHTML = ""; s.classList.remove('visible');
    }

    // === –ö–æ–Ω—Ñ–∏–≥ (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç) –∏ —Ä–µ–Ω–¥–µ—Ä –≥—Ä—É–ø–ø ===
    function getConfigUrl() {
      // URL –∫–æ–Ω—Ñ–∏–≥–∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      return window.AndroidInterface?.getConfigUrl?.() || "";
    }

    async function ensureConfig() {
      if (cachedConfig) return cachedConfig;
      const url = getConfigUrl();
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥');
      const cfg = await r.json();
      cachedConfig = cfg;
      return cfg;
    }

    function createGroupIcon(url) {
      const isSvg = /\.svg(\?|$)/i.test(url);
      const makeImg = () => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = '';
        img.style.height = '25px';
        img.style.width = '25px';
        img.style.objectFit = 'contain';
        return img;
      };

      if (!isSvg) return makeImg();

      const img = makeImg();
      img.onerror = () => {
        // –§–æ–ª–±—ç–∫: CSS background-image (—á–∞—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ WebView, –∫–æ–≥–¥–∞ <img> —Å SVG –Ω–µ—Ç)
        const box = document.createElement('div');
        box.style.width = '25px';
        box.style.height = '25px';
        box.style.backgroundImage = `url("${url}")`;
        box.style.backgroundRepeat = 'no-repeat';
        box.style.backgroundSize = 'contain';
        box.style.backgroundPosition = 'center';
        img.replaceWith(box);
      };
      return img;
    }

    function renderGroupsFromConfig(config) {
      const container = document.getElementById('groupCards') || document.querySelector('.card-container');
      if (!container) return;
      container.innerHTML = '';

      const groups = config.groups || {};
      const entries = Object.entries(groups);
      if (!entries.length) {
        container.innerHTML = '<div style="opacity:.7">–ù–µ—Ç –≥—Ä—É–ø–ø</div>';
        return;
      }

      entries.forEach(([groupKey, groupObj]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('tabindex', '0');
        card.dataset.group = groupKey;

        if (groupObj && groupObj.icon) {
          const iconEl = createGroupIcon(groupObj.icon);
          card.appendChild(iconEl);
        }
        card.appendChild(document.createTextNode(groupKey));

        card.onclick = () => selectCard(card);
        card.onfocus = () => selectCard(card);

        container.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      ensureConfig()
        .then(cfg => { renderGroupsFromConfig(cfg); })
        .catch(() => { /* –ø–æ–∫–∞–∂–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å */ });
    });

    async function startInstall() {
      const group = currentGroup;
      const password = savedPassword;
      const status = document.getElementById('status');
      if (!group) { status.innerHTML = "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç."; status.style.color = "red"; status.classList.add('visible'); return; }

      try {
        const config = await ensureConfig();
        const groupInfo = (config.groups || {})[group];
        if (!groupInfo) { status.innerHTML = "‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; status.style.color = "red"; status.classList.add('visible'); return; }
        if ((groupInfo.password || "") !== (password || "")) { showToast({ message: "üîí –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!" }); return; }
        cachedConfig = config;
        lastFocusedElement = document.activeElement;
        showGroupList(config);
      } catch (error) {
        status.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."; status.style.color = "red"; status.classList.add('visible');
      }
    }

    function showStatus(message, color, timeout = 4000) {
      const status = document.getElementById('status');
      status.innerHTML = message; status.style.color = color; status.classList.add('visible');
      clearTimeout(status.hideTimer);
      status.hideTimer = setTimeout(() => status.classList.remove('visible'), timeout);
    }

    function getToastStack(position = 'bottom-center') {
      const id = `toast-stack-${position}`; let stack = document.getElementById(id);
      if (stack) return stack;
      const [v,h] = position.split('-');
      stack = document.createElement('div');
      stack.id = id;
      stack.className = `toast-stack toast-stack--${v} ${h === 'center' ? 'toast-stack--centerX' : (h === 'left' ? 'toast-stack--left' : 'toast-stack--right')} ${v === 'center' ? 'toast-stack--center' : ''}`;
      document.body.appendChild(stack);
      return stack;
    }
    function showToast({ message, type="info", iconUrl=null, withSpin=false, position="bottom-center", variant="default", duration=3000, anchor=null, offset=10, colors=null }) {
      if (!message) return;
      const styles = {
        success: { bg: "rgba(0,128,0,.85)", text: "#fff" },
        error:   { bg: "rgba(220,0,0,.9)",  text: "#fff" },
        warning: { bg: "rgba(255,165,0,.9)", text: "#000" },
        info:    { bg: "rgba(242,0,0,.85)", text: "#fff" },
        blue:    { bg: "rgba(0,123,255,.9)", text: "#fff" },
        pink:    { bg: "rgba(255,105,180,.9)", text: "#000" }
      };
      const scheme = colors || styles[type] || styles.info;

      const toast = document.createElement('div');
      toast.className = 'toast' + (variant==='pill'?' toast--pill':'') + (variant==='compact'?' toast--compact':'') + (variant==='card'?' toast--card':'');
      toast.style.backgroundColor = scheme.bg; toast.style.color = scheme.text;
      let html = '';
      if (withSpin) html += `<span class="spin">‚è≥</span>`;
      html += `<span>${message}</span>`;
      if (iconUrl) html += `<img src="${iconUrl}" alt="" style="height:20px; width:20px; object-fit:contain; vertical-align:middle;">`;
      toast.innerHTML = html;

      let cleanup;
      if (anchor) {
        const el = typeof anchor === 'string' ? document.querySelector(anchor) : anchor;
        const rect = el?.getBoundingClientRect();
        toast.classList.add('toast--anchored'); document.body.appendChild(toast);
        const top = (rect?.bottom ?? 0) + offset;
        const left = (rect ? rect.left + rect.width / 2 : window.innerWidth / 2);
        toast.style.top = `${top}px`; toast.style.left = `${left}px`; toast.style.transform = 'translateX(-50%)';
        cleanup = () => toast.remove();
      } else {
        const stack = getToastStack(position); stack.appendChild(toast);
        cleanup = () => { toast.remove(); if (!stack.children.length) stack.remove(); };
      }
      requestAnimationFrame(() => toast.classList.add('show'));
      const hide = () => { toast.classList.remove('show'); setTimeout(cleanup, 250); };
      const timer = setTimeout(hide, duration);
      toast.addEventListener('click', () => { clearTimeout(timer); hide(); });
    }

    // ===== –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø—ã =====
    function showGroupList(config)  {
      const modal = document.getElementById('modal');
      const list  = document.getElementById('modalList');
      list.innerHTML = "";

      const apps    = (config.apps || []).filter(app => (app.tags || []).includes(currentGroup));
      const backups = (config.backups || []).filter(backup => (backup.tags || []).includes(currentGroup));
      const links   = (config.links || []).filter(link => (link.tags || []).includes(currentGroup));
      if (apps.length === 0 && backups.length === 0 && links.length === 0) list.innerHTML = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.";

      apps.forEach(app => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0'); btn.textContent = app.file;
        btn.onclick = () => {
          showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ APK...<span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(45).png" style="height:29px; vertical-align:middle;"></span>`, "#00cfff", 4000);
          window.AndroidInterface?.installSingle(app.url, app.file || "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ");
        };
        list.appendChild(btn);
      });

      backups.forEach(backup => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0'); btn.textContent = backup.file;
        btn.onclick = () => {
          const urls = backup.urls || (backup.url ? [backup.url] : []);
          if (!urls.length) return;
          showStatus(`–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤... <span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(45).png" style="height:29px; vertical-align:middle;"></span>`, "#00cfff", 4000);
          window.AndroidInterface?.copyMultipleBackups(JSON.stringify(urls), backup.target_folder);
        };
        list.appendChild(btn);
      });

      links.forEach(link => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0'); btn.textContent = link.file;
        btn.onclick = () => { showStatus("üîó –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...", "green", 3000); window.AndroidInterface?.openLink(link.url); };
        list.appendChild(btn);
      });

      modal.style.display = "flex";
      setTimeout(() => { document.querySelector('#modalList .component-btn')?.focus({ preventScroll: true }); }, 80);
    }


    

    function installAll() {
  if (window.AndroidInterface) {
    requestAnimationFrame(() => {
      setTimeout(() => {
        window.AndroidInterface.startInstallation(currentGroup);
      }, 100);  // –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 200-300, –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ –≤–∏–¥–Ω–æ
    });
  }
}

 function installAllSend() {
  /* showStatus("‚è≥ –ù–∞—á–∞–ª–∞—Å—å –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ–∂–∏–¥–∞–π—Ç–µ!!! <span class='spin'>‚è≥</span>", "orange", 4000); */
showStatus(`–ù–∞—á–∞–ª–∞—Å—å –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ–∂–∏–¥–∞–π—Ç–µ!!!<span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/–ë–µ–∑%20–Ω–∞–∑–≤–∞–Ω–∏—è%20(45).png" style="height:29px; vertical-align:middle;"></span>`, "#00cfff", 4000);
 }
    


    function closeModal() {
      const modal = document.getElementById('modal');
      modal.style.display = "none";
      if (lastFocusedElement && document.body.contains(lastFocusedElement)) {
        if (lastFocusedElement.classList?.contains('card')) selectCard(lastFocusedElement);
        lastFocusedElement.focus?.({ preventScroll: true });
      }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –º–æ–¥–∞–ª–∫–µ –≥—Ä—É–ø–ø (2 –∫–æ–ª–æ–Ω–∫–∏)
    (function () {
      const modal     = document.getElementById('modal');
      const list      = document.getElementById('modalList');
      const container = document.getElementById('modalListContainer');
      const cols = 2;
      let navLock = false;
      let lastIndexBeforeFooter = null;

      function focusAndReveal(el, margin = 12) {
        if (!el || !container) return;
        const cr = container.getBoundingClientRect();
        const er = el.getBoundingClientRect();
        if (er.top < cr.top + margin) container.scrollTop -= (cr.top + margin - er.top);
        else if (er.bottom > cr.bottom - margin) container.scrollTop += (er.bottom - (cr.bottom - margin));
        requestAnimationFrame(() => el.focus({ preventScroll: true }));
      }

      document.addEventListener('keydown', (e) => {
        if (modal.style.display !== 'flex') return;
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
        const installModal = document.getElementById('installMethodModal');
        if (installModal && installModal.style.display === 'flex') return;
        
        const keys = ['ArrowDown','ArrowUp','ArrowLeft','ArrowRight','Enter'];
        if (!keys.includes(e.key)) return;
        if (e.repeat) { e.preventDefault(); return; }

        const buttons = Array.from(list.querySelectorAll('.component-btn'));
        if (!buttons.length) return;

        const installBtn = document.getElementById('installAllBtn');
        const active = document.activeElement;

        if (active === installBtn) {
          e.preventDefault(); e.stopPropagation();
          if (e.key === 'ArrowDown') return;

          const lastRowStart = Math.floor((buttons.length - 1) / cols) * cols;
          const fallbackCol = 0;
          const colFromMemory = (lastIndexBeforeFooter != null) ? (lastIndexBeforeFooter % cols) : fallbackCol;
          const targetIndex = Math.min(lastRowStart + colFromMemory, buttons.length - 1);

          if (e.key === 'ArrowUp') { focusAndReveal(buttons[targetIndex]); return; }
          if (e.key === 'ArrowLeft') { const leftIndex = Math.max(targetIndex - 1, lastRowStart); focusAndReveal(buttons[leftIndex]); return; }
          if (e.key === 'ArrowRight') { const rowEnd = Math.min(lastRowStart + cols - 1, buttons.length - 1); const rightIndex = Math.min(targetIndex + 1, rowEnd); focusAndReveal(buttons[rightIndex]); return; }
          if (e.key === 'Enter') { installBtn.click(); return; }
          return;
        }

        let index = buttons.indexOf(active);
        if (index === -1) { e.preventDefault(); focusAndReveal(buttons[0]); return; }

        e.preventDefault(); e.stopPropagation();
        if (e.key === 'Enter') { active?.click(); return; }
        if (navLock) return;
        navLock = true; setTimeout(() => (navLock = false), 90);

        if (e.key === 'ArrowDown') {
          if (index + cols < buttons.length) { focusAndReveal(buttons[index + cols]); }
          else { lastIndexBeforeFooter = index; installBtn?.focus({ preventScroll: true }); }
          return;
        }
        if (e.key === 'ArrowUp') { const prev = index - cols; focusAndReveal(buttons[Math.max(prev, 0)]); return; }
        if (e.key === 'ArrowRight') { if ((index % cols) < (cols - 1) && index + 1 < buttons.length) focusAndReveal(buttons[index + 1]); return; }
        if (e.key === 'ArrowLeft') { if ((index % cols) > 0) focusAndReveal(buttons[index - 1]); return; }
      });
    })();

    function handleBackButton() {
      if (document.getElementById('installMethodModal')?.style.display === 'flex') closeInstallMethodSettings();
      else if (document.getElementById('miscModal')?.style.display === 'flex') closeMiscModal();
      else if (document.getElementById('autostartModal')?.style.display === 'flex') closeAutostartModal();
      else if (document.getElementById('modal')?.style.display === 'flex') closeModal();
      else { window.AndroidInterface.requestAppExit(); }
    }

    // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É" –Ω–∞ –¢–í
    (function(){
      const isTV = /TV|AFT|GoogleTV|SHIELD/i.test(navigator.userAgent);
      if (isTV) { const startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.style.display = "none"; }
    })();

   function updateProgress(current=null, total=null, percent=0, label) {
      const container = document.getElementById("progress-container");
      const bar = document.getElementById("progress-bar");
      const text = document.getElementById("progress-text");
      container.style.display = "block"; 
      bar.style.width = percent + "%";
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ undefined –∏ null –∑–Ω–∞—á–µ–Ω–∏—è
      if (current !== null && total !== null && current !== undefined && total !== undefined && label) {
        text.innerHTML = `–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:&nbsp;&nbsp; ${label}&nbsp;&nbsp;&nbsp;&nbsp;${percent}%`;
      } else {
        text.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞...`;
      }
      if (percent >= 100 && (current === null || current === total)) {
        setTimeout(() => { container.style.display = "none"; bar.style.width = "0%"; text.innerHTML = ""; }, 1500);
      }
    }
    function updateProgressWithLabel(current, total, percent, label) {
      const container = document.getElementById("progress-container");
      const bar = document.getElementById("progress-bar");
      const text = document.getElementById("progress-text");
      container.style.display = "block"; bar.style.width = percent + "%"; text.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ ${label}: ${percent}%`;
      if (percent >= 100 && current === total) setTimeout(() => { container.style.display = "none"; bar.style.width = "0%"; text.innerText = ""; }, 1500);
    }

    function openAutostartModal() {
      lastFocusedElement = document.activeElement;
      const modal = document.getElementById('autostartModal');
      const list = document.getElementById('autostartList');
      const current = document.getElementById('autostartCurrent');
      current.innerHTML = '<span style="color:#00cfff;">–ë–µ–∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</span>';

      window.AndroidInterface?.getCurrentAutostartApp();

      modal.style.display = 'flex';
      list.innerHTML = '<div style="grid-column:1/-1; text-align:center;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';

      window.AndroidInterface?.getUserApps();

      setTimeout(() => {
        const first = list.querySelector('.card, button');
        if (first) first.focus(); else { modal.setAttribute('tabindex','-1'); modal.focus(); }
      }, 400);
    }

    function setCurrentAutostartApp(appLabel, appIcon) {
      const current = document.getElementById("autostartCurrent");
      current.innerHTML = `
        <span style="font-weight:bold; color:#00cfff;">–ê–∫—Ç–∏–≤–Ω–æ–µ:</span>
        <img src="${appIcon}" alt="" style="height:24px; vertical-align:middle; margin:0 6px;">
        <span style="font-weight:bold;">${appLabel}</span>`;
    }

    function closeAutostartModal() {
      document.getElementById('autostartModal').style.display = 'none';
      if (lastFocusedElement && document.body.contains(lastFocusedElement)) lastFocusedElement.focus();
    }

    /* === helpers –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ === */
    function getAutostartCols() {
      const grid = document.getElementById('autostartList');
      if (!grid) return 5;
      const cs = getComputedStyle(grid);
      const tpl = cs.getPropertyValue('grid-template-columns');
      const count = (tpl || '').split(' ').filter(Boolean).length;
      return count || 5;
    }
    function focusAndRevealAuto(el, margin = 12) {
      const container = document.getElementById('autostartListContainer');
      if (!el || !container) return;
      const cr = container.getBoundingClientRect();
      const er = el.getBoundingClientRect();
      if (er.top < cr.top + margin) container.scrollTop -= (cr.top + margin - er.top);
      else if (er.bottom > cr.bottom - margin) container.scrollTop += (er.bottom - (cr.bottom - margin));
      requestAnimationFrame(() => el.focus({ preventScroll: true }));
    }

    function renderAppSelection(json) {
      const apps = JSON.parse(json);
      const list = document.getElementById('autostartList');
      list.innerHTML = '';

      apps.forEach(app => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('tabindex', '0');
        card.innerHTML = `<img src="${app.icon}" alt="" style="height:24px;"><br>${app.label}`;

        card.onclick = (ev) => {
          ev.preventDefault(); ev.stopPropagation();
          window.AndroidInterface.saveAutostartPackage(app.package);
          setCurrentAutostartApp(app.label, app.icon);
          showToast({ message: `${app.label} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫`, iconUrl: app.icon, type: "success" });
        };

        // –í–ê–ñ–ù–û: –Ω–µ –º–µ–Ω—è—Ç—å "–í—ã–±—Ä–∞–Ω–æ" –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª
        card.onfocus = () => {
          document.querySelectorAll('#autostartList .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          const cur = document.getElementById("autostartCurrent");
          if (cur) cur.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + applabel; // ‚Üê –ø–æ —Ç–≤–æ–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
          focusAndRevealAuto(card);
        };
        card.onblur = () => card.classList.remove('selected');

        list.appendChild(card);
      });

      setTimeout(() => { const first = list.querySelector('.card'); if (first) focusAndRevealAuto(first); }, 100);
    }

    function disableAutostart() {
      window.AndroidInterface?.DeleteAutostartPackage("");
      const current = document.getElementById('autostartCurrent');
      if (current) current.innerHTML = '<span style="color:#00cfff;">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω</span>';
      showToast({ message: "–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω" });
    }

    function hideProgress() {
      const container = document.getElementById('progress-container');
      const bar = document.getElementById('progress-bar');
      const text = document.getElementById('progress-text');
      if (container) container.style.display = 'none';
      if (bar) bar.style.width = '0%';
      if (text) text.innerText = '';
    }

    function onInstalledAppsReceived(appsJson) {
      const container = document.getElementById('appList');
      if (!container) return;
      container.innerHTML = '';
      let apps;
      try { apps = JSON.parse(appsJson); }
      catch (e) { container.innerHTML = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.'; return; }

      apps.forEach(app => {
        const btn = document.createElement('button');
        btn.textContent = `${app.name} (${app.package})`;
        btn.onclick = () => { window.AndroidInterface.setAutostartPackage(app.package); alert("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: " + app.name); closeAutostartModal(); };
        container.appendChild(btn);
        container.appendChild(document.createElement('br'));
      });
    }

    // –°–Ω—è—Ç–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å –≥—Ä—É–ø–ø—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –Ω–∏–∂–Ω–∏—Ö –∫–Ω–æ–ø–∫–∞—Ö
    document.querySelectorAll(".system-buttons .sys-btn, #passwordBtn, #startBtn").forEach(btn => {
      btn.addEventListener("focus", () => { document.querySelectorAll(".card").forEach(c => c.classList.remove("selected")); });
    });

    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }, 3000);

    // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–µ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏, ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª –≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ —Å–∫—Ä–æ–ª–ª–∞) ===
    (function attachAutostartNavOnce(){
      if (window.__autoStartNavBoundV4) return;
      window.__autoStartNavBoundV4 = true;

      let lastIndexBeforeHeader = null; // –æ—Ç–∫—É–¥–∞ —É—à–ª–∏ –ù–ê –≤–µ—Ä—Ö–Ω—é—é –∫–Ω–æ–ø–∫—É
      let lastIndexBeforeFooter = null; // –æ—Ç–∫—É–¥–∞ —É—à–ª–∏ –ù–ê "–ó–∞–∫—Ä—ã—Ç—å"

      document.addEventListener('keydown', function (e) {
        const modal = document.getElementById('autostartModal');
        if (!modal || modal.style.display !== 'flex') return;
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
        const installModal = document.getElementById('installMethodModal');
        if (installModal && installModal.style.display === 'flex') return;

        e.stopPropagation();
        e.stopImmediatePropagation();

        const list      = document.getElementById('autostartList');
        const cards     = Array.from(list.querySelectorAll('.card'));
        const headerBtn = modal.querySelector('.sys-btn'); // üö´ –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
        const closeBtn  = document.getElementById('autostartCloseBtn');
        if (!cards.length) return;

        const cols   = getAutostartCols();
        const active = document.activeElement;

        // –í–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞
        if (active === headerBtn) {
          document.querySelectorAll('#autostartList .card.selected').forEach(c => c.classList.remove('selected'));
          switch (e.key) {
            case 'ArrowDown': {
              e.preventDefault();
              const col = (lastIndexBeforeHeader != null) ? (lastIndexBeforeHeader % cols) : 0;
              const targetIndex = Math.min(col, cards.length - 1);
              focusAndRevealAuto(cards[targetIndex]);
              break;
            }
            case 'ArrowUp':
            case 'ArrowLeft':
            case 'ArrowRight':
              e.preventDefault(); break;
            case 'Enter':
              e.preventDefault(); headerBtn.click(); break;
            case 'Back':
            case 'Escape':
              e.preventDefault(); closeAutostartModal(); break;
          }
          return;
        }

        // –ù–∏–∂–Ω—è—è –∫–Ω–æ–ø–∫–∞ (–≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
        if (active === closeBtn) {
          document.querySelectorAll('#autostartList .card.selected').forEach(c => c.classList.remove('selected'));
          switch (e.key) {
            case 'ArrowUp': {
              e.preventDefault();
              const total = cards.length;
              const lastRow = Math.floor((total - 1) / cols);
              const lastRowStart = lastRow * cols;
              const col = (lastIndexBeforeFooter != null) ? (lastIndexBeforeFooter % cols) : 0;
              const targetIndex = Math.min(lastRowStart + col, total - 1);
              focusAndRevealAuto(cards[targetIndex]);
              break;
            }
            case 'ArrowDown':
            case 'ArrowLeft':
            case 'ArrowRight':
              e.preventDefault(); break; // —É–ø–æ—Ä –≤–Ω–∏–∑—É
            case 'Enter':
              e.preventDefault(); closeBtn.click(); break;
            case 'Back':
            case 'Escape':
              e.preventDefault(); closeAutostartModal(); break;
          }
          return;
        }

        // –û–±—ã—á–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
        const index = cards.indexOf(active);
        if (index === -1 && e.key.startsWith('Arrow')) {
          e.preventDefault();
          focusAndRevealAuto(cards[0]);
          return;
        }

        const total = cards.length;
        const row   = Math.floor(index / cols);
        const col   = index % cols;
        const lastRow = Math.floor((total - 1) / cols);
        const lastRowStart = lastRow * cols;

        switch (e.key) {
          case 'ArrowDown': {
            e.preventDefault();
            if (row < lastRow) {
              // –ö–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–¥ –Ω–∞–º–∏
              const nextIndex = (row + 1) * cols + col;
              const targetIndex = (nextIndex < total) ? nextIndex : Math.min(lastRowStart + col, total - 1);
              focusAndRevealAuto(cards[targetIndex]);
            } else {
              // –£–∂–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ ‚Äî —É—Ö–æ–¥–∏–º –Ω–∞ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª
              lastIndexBeforeFooter = index;
              cards[index]?.classList.remove('selected');
              if (closeBtn) focusAndRevealAuto(closeBtn);
            }
            break;
          }
          case 'ArrowUp': {
            e.preventDefault();
            if (row === 0) {
              lastIndexBeforeHeader = index;
              cards[index]?.classList.remove('selected');
              headerBtn?.focus({ preventScroll: true });
            } else {
              const prevIndex = (row - 1) * cols + col;
              focusAndRevealAuto(cards[prevIndex]);
            }
            break;
          }
          case 'ArrowLeft': {
            e.preventDefault();
            if (col === 0) return;
            const target = index - 1;
            if (target >= 0) focusAndRevealAuto(cards[target]);
            break;
          }
          case 'ArrowRight': {
            e.preventDefault();
            const inRowEnd = (col === cols - 1) || (index + 1 >= total);
            if (inRowEnd) return;
            focusAndRevealAuto(cards[index + 1]);
            break;
          }
          case 'Enter':
            e.preventDefault(); active?.click(); break;
          case 'Back':
          case 'Escape':
            e.preventDefault(); closeAutostartModal(); break;
        }
      });
    })();

    // misc modal open/close
    function openMiscModal() {
      lastFocusedElement = document.activeElement;
      const modal = document.getElementById("miscModal");
      modal.style.display = "flex";
      document.body.classList.add("modal-open");
      document.activeElement?.blur();
      const firstBtn = modal.querySelector('.sys-btn');
      if (firstBtn) setTimeout(() => firstBtn.focus(), 100); else modal.focus();
    }
    function closeMiscModal() {
      const modal = document.getElementById("miscModal");
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
      setTimeout(() => { if (lastFocusedElement && document.body.contains(lastFocusedElement)) lastFocusedElement.focus?.(); lastFocusedElement = null; }, 50);
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –º–æ–¥–∞–ª–∫–µ "–†–∞–∑–Ω–æ–µ" (–∫–∞–∫ –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–µ - –ø–æ —Å–µ—Ç–∫–µ 2 –∫–æ–ª–æ–Ω–∫–∏)
    (function attachMiscNavOnce(){
      if (window.__miscNavBound) return;
      window.__miscNavBound = true;

      let lastIndexBeforeFooter = null;

      function focusAndReveal(el, margin = 12) {
        if (!el) return;
        const container = document.querySelector('#miscModal .misc-buttons-container');
        if (!container) return;
        const cr = container.getBoundingClientRect();
        const er = el.getBoundingClientRect();
        if (er.top < cr.top + margin) container.scrollTop -= (cr.top + margin - er.top);
        else if (er.bottom > cr.bottom - margin) container.scrollTop += (er.bottom - (cr.bottom - margin));
        requestAnimationFrame(() => el.focus({ preventScroll: true }));
      }

      document.addEventListener('keydown', function (e) {
        const modal = document.getElementById('miscModal');
        if (!modal || modal.style.display !== 'flex') return;
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
        const installModal = document.getElementById('installMethodModal');
        if (installModal && installModal.style.display === 'flex') {
          // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –º–æ–¥–∞–ª–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          return;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
        if (e.defaultPrevented) return;

        e.stopPropagation();
        e.stopImmediatePropagation();

        const buttons = Array.from(modal.querySelectorAll('.misc-buttons-container .sys-btn'));
        if (!buttons.length) return;

        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫
        function getColumnsCount(buttons) {
          if (buttons.length < 2) return 1;
          const firstTop = buttons[0].getBoundingClientRect().top;
          let cols = 1;
          for (let i = 1; i < buttons.length; i++) {
            if (Math.abs(buttons[i].getBoundingClientRect().top - firstTop) < 5) {
              cols++;
            } else break;
          }
          return cols;
        }
        const cols = getColumnsCount(buttons);
        const active = document.activeElement;

        // –û–±—ã—á–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
        const index = buttons.indexOf(active);
        if (index === -1 && e.key.startsWith('Arrow')) {
          e.preventDefault();
          focusAndReveal(buttons[0]);
          return;
        }

        const total = buttons.length;
        const row   = Math.floor(index / cols);
        const col   = index % cols;
        const lastRow = Math.floor((total - 1) / cols);
        const lastRowStart = lastRow * cols;

        switch (e.key) {
          case 'ArrowDown': {
            e.preventDefault();
            if (row < lastRow) {
              const nextIndex = (row + 1) * cols + col;
              const targetIndex = (nextIndex < total) ? nextIndex : Math.min(lastRowStart + col, total - 1);
              focusAndReveal(buttons[targetIndex]);
            }
            // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∫–Ω–æ–ø–∫–µ "–ó–∞–∫—Ä—ã—Ç—å" - –µ—ë –±–æ–ª—å—à–µ –Ω–µ—Ç
            break;
          }
          case 'ArrowUp': {
            e.preventDefault();
            if (row === 0) return; // —É–ø–æ—Ä –≤–≤–µ—Ä—Ö—É
            const prevIndex = (row - 1) * cols + col;
            focusAndReveal(buttons[prevIndex]);
            break;
          }
          case 'ArrowLeft': {
            e.preventDefault();
            if (col === 0) return;
            const target = index - 1;
            if (target >= 0) focusAndReveal(buttons[target]);
            break;
          }
          case 'ArrowRight': {
            e.preventDefault();
            const inRowEnd = (col === cols - 1) || (index + 1 >= total);
            if (inRowEnd) return;
            focusAndReveal(buttons[index + 1]);
            break;
          }
          case 'Enter':
            e.preventDefault(); active?.click(); break;
          case 'Back':
          case 'Escape':
            e.preventDefault(); closeMiscModal(); break;
        }
      });
    })();

  </script>
<script>
// 1) –†–µ–∂–µ–º –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä –∫–ª–∞–≤–∏—à–∏ Enter/OK –ø–æ –≤—Å–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (CAPTURE + immediate)
document.addEventListener('keydown', function(e) {
  const isEnter = (e.key === 'Enter' || e.code === 'Enter' || e.key === 'NumpadEnter' || e.key === 'OK');
  if (isEnter && e.repeat) {
    e.preventDefault();
    e.stopImmediatePropagation();
  }
}, true);

// 2) –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–µ–±–∞—É–Ω—Å ¬´–∫–ª–∏–∫–æ–≤ –æ—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è¬ª ‚Äî –ø–µ—Ä-—ç–ª–µ–º–µ–Ω—Ç–Ω—ã–π
const __lastClickByEl = new WeakMap();
document.addEventListener('click', function(e) {
  const target = e.target.closest('button, [role="button"], .component-btn, #installAllBtn');
  if (!target) return;
  const now = Date.now();
  const last = __lastClickByEl.get(target) || 0;
  const interval = 700; // –º–æ–∂–Ω–æ 500..900 –º—Å

  if (now - last < interval) {
    e.preventDefault();
    e.stopImmediatePropagation();
    return;
  }
  __lastClickByEl.set(target, now);
}, true);

// –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–∞–∫ –º–æ–¥–∞–ª–∫–∞ "–†–∞–∑–Ω–æ–µ")
function showInstallMethodSettings() {
    lastFocusedElement = document.activeElement;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    const currentMethod = window.AndroidInterface?.getInstallMethod?.() || 'sai';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥ –≤ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
    const radioBtn = document.getElementById('method_' + currentMethod);
    if (radioBtn) radioBtn.checked = true;
    
    // freeze –†–∞–∑–Ω–æ–µ, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
    const misc = document.getElementById('miscModal');
    if (misc && misc.style.display === 'flex') {
      misc.setAttribute('inert', '');
      misc.style.pointerEvents = 'none';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const modal = document.getElementById("installMethodModal");
    modal.style.display = "flex";
    document.body.classList.add("modal-open");
    document.activeElement?.blur();
    const firstOption = modal.querySelector('.method-option');
    if (firstOption) setTimeout(() => firstOption.focus(), 100); else modal.focus();
}

// –ó–∞–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–∞–∫ –º–æ–¥–∞–ª–∫–∞ "–†–∞–∑–Ω–æ–µ")
function closeInstallMethodSettings() {
    const modal = document.getElementById("installMethodModal");
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
    
    // unfreeze –†–∞–∑–Ω–æ–µ
    const misc = document.getElementById('miscModal');
    if (misc) { 
      misc.removeAttribute('inert'); 
      misc.style.pointerEvents = ''; 
    }
    
    setTimeout(() => { if (lastFocusedElement && document.body.contains(lastFocusedElement)) lastFocusedElement.focus?.(); lastFocusedElement = null; }, 50);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="install_method"]');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
                window.AndroidInterface.setInstallMethod(this.value);
            }
        });
    });
});

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –º–æ–¥–∞–ª–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–∞–∫ –º–æ–¥–∞–ª–∫–∞ "–†–∞–∑–Ω–æ–µ")
(function attachInstallMethodNavOnce(){
  if (window.__installMethodNavBound) return;
  window.__installMethodNavBound = true;

  let lastIndexBeforeFooter = null;
  
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ Back —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
  window.addEventListener('keydown', function (e) {
    if (e.key === 'Back' || e.key === 'Escape') {
      const installModal = document.getElementById('installMethodModal');
      if (installModal && installModal.style.display === 'flex') {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        closeInstallMethodSettings();
        return;
      }
    }
  }, true);

  document.addEventListener('keydown', function (e) {
    const modal = document.getElementById('installMethodModal');
    if (!modal || modal.style.display !== 'flex') return;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –í–°–ï —Å–æ–±—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–æ–¥–∞–ª–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ Back
    if (e.key === 'Back' || e.key === 'Escape') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    }

    const options = Array.from(document.querySelectorAll('#installMethodModal .method-option'));
    const closeBtn = document.querySelector('#installMethodModal .sys-btn');
    if (!options.length) return;

    const cols = 1; // 1 –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    const active = document.activeElement;

    // –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å"
    if (active === closeBtn) {
      switch (e.key) {
        case 'ArrowUp': {
          const total = options.length;
          const lastRow = Math.floor((total - 1) / cols);
          const lastRowStart = lastRow * cols;
          const col = (lastIndexBeforeFooter != null) ? (lastIndexBeforeFooter % cols) : 0;
          const targetIndex = Math.min(lastRowStart + col, total - 1);
          options[targetIndex]?.focus({ preventScroll: true });
          break;
        }
        case 'ArrowDown':
        case 'ArrowLeft':
        case 'ArrowRight':
          break;
        case 'Enter':
          closeBtn.click(); break;
        case 'Back':
        case 'Escape':
          closeInstallMethodSettings(); break;
      }
      return;
    }

    // –û–±—ã—á–Ω–∞—è —Å–µ—Ç–∫–∞ –æ–ø—Ü–∏–π
    const index = options.indexOf(active);
    if (index === -1 && e.key.startsWith('Arrow')) {
      options[0]?.focus({ preventScroll: true });
      return;
    }

    const total = options.length;
    const row   = Math.floor(index / cols);
    const col   = index % cols;
    const lastRow = Math.floor((total - 1) / cols);
    const lastRowStart = lastRow * cols;

    switch (e.key) {
      case 'ArrowDown': {
        if (row < lastRow) {
          const nextIndex = (row + 1) * cols + col;
          const targetIndex = (nextIndex < total) ? nextIndex : Math.min(lastRowStart + col, total - 1);
          options[targetIndex]?.focus({ preventScroll: true });
        } else {
          lastIndexBeforeFooter = index;
          closeBtn?.focus({ preventScroll: true });
        }
        break;
      }
      case 'ArrowUp': {
        if (row === 0) return; // —É–ø–æ—Ä –≤–≤–µ—Ä—Ö—É
        const prevIndex = (row - 1) * cols + col;
        options[prevIndex]?.focus({ preventScroll: true });
        break;
      }
      case 'ArrowLeft':
      case 'ArrowRight':
        break; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
      case 'Enter':
        if (index >= 0) {
          const method = options[index].querySelector('input[type="radio"]').value;
          selectInstallMethod(method, options[index]);
        }
        break;
      case 'Back':
      case 'Escape':
        closeInstallMethodSettings(); break;
    }
  }, true); // –î–æ–±–∞–≤–ª—è–µ–º capture: true –¥–ª—è –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
})();

function selectInstallMethod(method, targetElement = null) {
  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –æ–ø—Ü–∏–π
  document.querySelectorAll('#installMethodModal .method-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
  const target = targetElement || (event && event.currentTarget);
  if (target) {
    target.classList.add('selected');
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫—É
  document.getElementById('method_' + method).checked = true;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
  if (window.AndroidInterface && window.AndroidInterface.setInstallMethod) {
    window.AndroidInterface.setInstallMethod(method);
  }
}

  
</script>
<!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
<div id="installMethodModal" class="modal" style="display:none;" tabindex="-1">
  <div class="modal-content">
    <h3>–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h3>
    <div class="install-method-settings">
      <div class="method-option" onclick="selectInstallMethod('sai', this)" tabindex="0">
        <input type="radio" id="method_sai" name="install_method" value="sai" checked>
        <label for="method_sai">
          <strong>–ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞</strong><br>
          <small>SAI-–º–µ—Ç–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</small>
        </label>
      </div>
      <div class="method-option" onclick="selectInstallMethod('standard', this)" tabindex="0">
        <input type="radio" id="method_standard" name="install_method" value="standard">
        <label for="method_standard">
          <strong>–û–±—ã—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞</strong><br>
          <small>–ß–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫</small>
        </label>
      </div>
    </div>
    <button onclick="closeInstallMethodSettings()" class="sys-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
  
  
</body>
</html>
