<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ ATV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ====== –ë–ê–ó–ê ====== */
    :root {
      --bg: #000;
      --fg: #fff;
      --card: #2a2a2a;
      --accent: #00cfff;
      --btn: #004d61;
    }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 40px; text-align: center; font-family: system-ui, -apple-system, Roboto, sans-serif;
      background: var(--bg); color: var(--fg);
    }
    select, input, button { font-size: 18px; padding: 10px; margin: 10px; width: 250px; }

    /* ====== –°–¢–ê–¢–£–°/–¢–û–°–¢ ====== */
    #status { margin-top: 20px; font-weight: bold; min-height: 24px; transition: opacity .5s ease; opacity: 0; position: fixed; top: 10px; left: 0; right: 0; text-align: center; z-index: 1001; }
    #status.visible { opacity: 1; }
    .spin { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }

    /* ====== –§–û–ö–£–°–´ ====== */
    select:focus, input:focus, button:focus { outline: none; box-shadow: 0 0 8px red; border-color: red; }

    /* ====== –ö–ê–†–¢–û–ß–ö–ò –ì–†–£–ü–ü ====== */
    .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .card { background: var(--card); border-radius: 16px; padding: 20px; width: 80px; height: 62px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--fg); font-size: 13px; border: 2px solid transparent; transition: all .2s ease; cursor: pointer; }
    .card:hover, .card:focus { background: var(--btn); border-color: var(--accent); box-shadow: 0 0 10px rgba(0,0,0,.5); outline: none; }
    .card.selected { background: var(--accent); color: #000; border: 2px solid #fff; }

    /* ====== –ú–û–î–ê–õ–ö–ò ====== */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: none; justify-content: center; align-items: center; z-index: 999; outline: none; }
    .modal[aria-hidden="false"] { display: flex; }
    .modal-content { background: #111; color: #fff; padding: 20px; border-radius: 10px; max-height: 80vh; overflow: hidden; width: min(1000px, 90vw); border: 1px solid #333; }

    /* ====== –°–ü–ò–°–û–ö –í –ú–û–î–ê–õ–ö–ï (#modal) ====== */
    #modalListContainer { max-height: 60vh; overflow-y: auto; overscroll-behavior: contain; scroll-behavior: auto; margin-top: 10px; }
    #modalList { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; justify-items: center; align-content: start; }
    #modalList .component-btn { scroll-margin-block: 16px; outline: none; }
    #modalList .component-btn:focus-visible { box-shadow: 0 0 0 3px rgba(255,255,255,.35); border-radius: 10px; }

    /* ====== –ö–ù–û–ü–ö–ò ====== */
    button { background: var(--btn); color: #fff; border: 2px solid transparent; border-radius: 8px; padding: 10px 20px; font-size: 14px; width: 250px; cursor: pointer; transition: background-color .2s ease, box-shadow .2s ease, border-color .2s ease; box-sizing: border-box; }
    button:hover { background: var(--accent); }
    button:focus { outline: none; border-color: #fff; box-shadow: 0 0 10px var(--btn); }

    .system-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 12px; }
    .sys-btn { flex: 1 1 calc(33.33% - 20px); min-width: 100px; max-width: 240px; padding: 10px; font-size: 13px; text-align: center; background: var(--btn); color: #fff; border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: background-color .3s ease; }
    .sys-btn:hover { background: var(--accent); }
    .sys-btn:focus { border-color: #fff; box-shadow: 0 0 10px var(--btn); }

    /* ====== –°–ü–õ–≠–® ====== */
    #splash { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    #logo { position: fixed; inset: 0; background: url('https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/usr.gif') no-repeat center/contain; z-index: 9999; }

    /* ====== –¢–û–°–¢–´ ====== */
    .toast { display: inline-flex; align-items: center; gap: 8px; box-sizing: border-box; background: rgba(0,0,0,.85); color: #fff; border-radius: 10px; padding: 12px 18px; font-size: 14px; line-height: 1.3; max-width: min(70vw, 720px); white-space: normal; overflow-wrap: anywhere; word-break: break-word; opacity: 0; transform: translateY(8px); transition: opacity .25s ease, transform .25s ease; pointer-events: auto; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast--pill { border-radius: 999px; padding: 10px 16px; }
    .toast--compact { padding: 8px 12px; font-size: 16px; }
    .toast--card { box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .toast .spin { display:inline-block; animation: spin 1s linear infinite; }
    .toast-stack { position: fixed; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast-stack--top { top: 40px; }
    .toast-stack--bottom { bottom: 40px; }
    .toast-stack--center { top: 50%; transform: translateY(-50%); }
    .toast-stack--left { left: 40px; align-items: flex-start; }
    .toast-stack--centerX { left: 50%; transform: translateX(-50%); align-items: center; }
    .toast-stack--right { right: 40px; align-items: flex-end; }
    .toast--anchored { position: fixed; z-index: 10000; }
  </style>
</head>
<body>
  <div id="splash"><div id="logo"></div></div>
  <div id="main-content" style="display:none;"></div>

  <h5 style="margin-top:0;">–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ ATV</h5>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
  <div id="progress-container" style="display:none; width:100%; background:#000; padding:5px; z-index:1002; position:fixed; top:0; left:0; right:0;">
    <div id="progress-text" style="color:#fff; margin-bottom:5px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div style="width:100%; background:#000; height:8px; border-radius:6px;">
      <div id="progress-bar" style="height:8px; width:0%; background:#42A5F5; border-radius:6px;"></div>
    </div>
  </div>

  <!-- –ì—Ä—É–ø–ø—ã -->
  <div class="card-container" id="groupCards">
    <div class="card" data-group="1" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(65).png" alt="–°—Ç–∞—Ä—Ç" style="height:28px;">–°—Ç–∞—Ä—Ç–æ–≤—ã–π</div>
    <div class="card" data-group="2" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(4).svg" alt="YouTube" style="height:23px;">YouTube</div>
    <div class="card" data-group="3" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(58).png" alt="–û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä—ã" style="height:28px;">–û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä—ã</div>
    <div class="card" data-group="4" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(46).png" alt="–¢–æ—Ä—Ä–µ–Ω—Ç" style="height:28px;">–¢–æ—Ä—Ä–µ–Ω—Ç + –ö–∏–Ω–æ</div>
    <div class="card" data-group="5" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(48).png" alt="IPTV" style="height:27px;">IPTV</div>
    <div class="card" data-group="6" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(52).svg" alt="IPTV + TorrentTV" style="height:28px;">IPTV + TorrentTV</div>
    <div class="card" data-group="7" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(67).png" alt="–ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞" style="height:25px;">–ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</div>
    <div class="card" data-group="8" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(64).png" alt="–ó–∞—è–≤–∫–∏" style="height:25px;">–ó–∞—è–≤–∫–∏</div>
  </div>

  <script>
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è currentGroup
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('focus', () => {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        currentGroup = card.dataset.group;
      });
    });

    // Enter –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ –æ—Ç–∫—Ä—ã—Ç—ã)
    document.addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      if (anyModalOpen()) return;
      const selected = document.querySelector('.card.selected');
      if (selected) currentGroup = selected.dataset.group;
    });
  </script>

  <select id="groupSelect" style="display:none;"></select>
  <button type="button" id="startBtn" onclick="startInstall()">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button>
  <button type="button" id="passwordBtn">üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</button>
  <div id="status"></div>

  <!-- –ö–Ω–æ–ø–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div class="system-buttons">
    <button onclick="event.stopPropagation();window.AndroidInterface.openUnknownSources()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(8).svg" alt="" style="height:18px;"><br>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAppSettingsList()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(42).png" alt="" style="height:24px;"><br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAccessibilitySettings()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(44).png" alt="" style="height:28px;"><br>–°–ø–µ—Ü –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openBatteryOptimization()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(34).png" alt="" style="height:24px;"><br>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAnydesk()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(12).svg" alt="" style="height:24px;"><br>AnyDesk</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openPlayMarket()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(13).svg" alt="" style="height:20px;"><br>Google Play</button>
    <button onclick="openAutostartModal()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(38).png" alt="" style="height:28px;"><br>–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFileManagerPlus()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(15).svg" alt="" style="height:26px;"><br>File Manager+</button>
    <button onclick="openMiscModal()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(19).png" alt="" style="height:28px;"><br>–ü–æ–ª–µ–∑–Ω–æ–µ</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ -->
  <div id="autostartModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div id="autostartCurrent" style="margin-bottom:10px; font-weight:bold;">–í—ã–±—Ä–∞–Ω–æ: –ù–µ—Ç</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞:</h3>
      <button onclick="disableAutostart()" class="sys-btn">üö´ –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫</button>
      <div id="autostartList" class="card-container" style="margin-top:10px;"></div>
      <button id="autostartCloseBtn" class="sys-btn" onclick="closeAutostartModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –¢–æ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π) -->
  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none;"></div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –†–∞–∑–Ω–æ–µ -->
  <div id="miscModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
    <div class="modal-content">
      <h3>–†–∞–∑–Ω–æ–µ</h3>
      <div class="system-buttons">
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFilePicker()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(15).svg" alt="" style="height:26px;"><br>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openSettingsForPackage('com.google.android.katniss')" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(6).svg" alt="" style="height:24px;"><br>Google Katniss</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAllAppsSide()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(11).svg" alt="" style="height:24px;"><br>–ú–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.deleteCopiedBackups()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(27).png" alt="" style="height:28px;"><br>–£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.clearWebCache()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(20).png" alt="" style="height:28px;"><br>–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAddAccountSettings()" class="sys-btn"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(40).png" alt="" style="height:28px;"><br>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.testAutostart()" class="sys-btn">üöÄ<br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</button>
      </div>
      <br />
      <button onclick="closeMiscModal()" class="sys-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≥—Ä—É–ø–ø—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3>–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:</h3>
      <div id="modalListContainer"><div id="modalList"></div></div>
      <br />
      <button id="installAllBtn" onclick="installAll()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë</button>
    </div>
  </div>

  <!-- ====== –õ–û–ì–ò–ö–ê ====== -->
  <script>
    let currentGroup = "";
    let cachedConfig = null;
    let lastFocusedElement = null;
    let lastPassword = "";
    let backupQueue = []; let backupTarget = ""; let savedPassword = "";

    // –ü–∞—Ä–æ–ª—å: –∫–Ω–æ–ø–∫–∞ –∏ –∫–æ–ª–±—ç–∫ –∏–∑ Android
    document.getElementById('passwordBtn').addEventListener('click', () => {
      const ai = window.AndroidInterface;
      if (ai?.requestPasswordPrefill) { ai.requestPasswordPrefill(savedPassword || ""); return; }
      if (ai?.requestPassword) { try { ai.requestPassword(savedPassword || ""); return; } catch(e) { ai.requestPassword(); return; } }
      const pwd = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", savedPassword || "");
      if (pwd !== null) { savedPassword = pwd.trim(); updatePasswordBtn(); }
    });
    function setPasswordFromAndroid(pwd) { savedPassword = (pwd || "").trim(); updatePasswordBtn(); }
    function updatePasswordBtn() { const btn = document.getElementById('passwordBtn'); btn.textContent = savedPassword ? `üîë –ü–∞—Ä–æ–ª—å: ${'*'.repeat(savedPassword.length)}` : 'üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'; }

    function anyModalOpen() { return ['modal','autostartModal','miscModal'].some(id => document.getElementById(id)?.getAttribute('aria-hidden') === 'false'); }

    let ignoreNextEnter = false;

    function copyBackupsSequentially(urls, folder) { if (!urls.length) return; backupQueue = urls; backupTarget = folder; copyNextBackup(); }
    function copyNextBackup() {
      if (backupQueue.length === 0) { showStatus('‚úÖ –í—Å–µ –±—ç–∫–∞–ø—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã', 'green'); return; }
      const url = backupQueue.shift(); const fileName = url.split('/').pop();
      showStatus(`‚è≥ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: ${fileName} <span class="spin"><img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(45).png" style="height:29px; vertical-align:middle;"></span>`, '#00cfff', 4000);
      window.AndroidInterface?.copyBackup(url, backupTarget);
    }
    function onBackupCopied() { copyNextBackup(); }

    function selectCard(card) {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected'); currentGroup = card.dataset.group;
      const st = document.getElementById('status'); st.innerHTML = ""; st.classList.remove('visible');
    }

    async function startInstall() {
      const group = currentGroup; const password = savedPassword; const status = document.getElementById('status');
      if (!group) { status.innerHTML = '‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç.'; status.style.color = 'red'; status.classList.add('visible'); return; }
      try {
        const response = await fetch('https://f4iptv.github.io/Play/old/config.json');
        const config = await response.json();
        const groupInfo = config.groups[group];
        if (!groupInfo) { status.innerHTML = '‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!'; status.style.color = 'red'; status.classList.add('visible'); return; }
        if (groupInfo.password !== password) { showToast({ message: 'üîí –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!' }); return; }
        cachedConfig = config; showGroupList(config);
      } catch (error) {
        status.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.'; status.style.color = 'red'; status.classList.add('visible');
      }
    }

    function showStatus(message, color, timeout = 4000) {
      const status = document.getElementById('status'); status.innerHTML = message; status.style.color = color; status.classList.add('visible');
      clearTimeout(status.hideTimer); status.hideTimer = setTimeout(() => { status.classList.remove('visible'); }, timeout);
    }

    function getToastStack(position = 'bottom-center') {
      const id = `toast-stack-${position}`; let stack = document.getElementById(id); if (stack) return stack;
      const [v,h] = position.split('-'); stack = document.createElement('div'); stack.id = id;
      stack.className = `toast-stack toast-stack--${v} ${h==='center'?'toast-stack--centerX':(h==='left'?'toast-stack--left':'toast-stack--right')} ${v==='center'?'toast-stack--center':''}`;
      document.body.appendChild(stack); return stack;
    }

    function showToast({ message, type = 'info', iconUrl = null, withSpin = false, position = 'bottom-center', variant = 'default', duration = 3000, anchor = null, offset = 10, colors = null }) {
      if (!message) return;
      const styles = { success:{bg:'rgba(0,128,0,.85)',text:'#fff'}, error:{bg:'rgba(220,0,0,.9)',text:'#fff'}, warning:{bg:'rgba(255,165,0,.9)',text:'#000'}, info:{bg:'rgba(242,0,0,.85)',text:'#fff'}, blue:{bg:'rgba(0,123,255,.9)',text:'#fff'}, pink:{bg:'rgba(255,105,180,.9)',text:'#000'} };
      const scheme = colors || styles[type] || styles.info;
      const toast = document.createElement('div'); toast.className = 'toast' + (variant==='pill'?' toast--pill':'') + (variant==='compact'?' toast--compact':'') + (variant==='card'?' toast--card':''); toast.style.backgroundColor = scheme.bg; toast.style.color = scheme.text;
      let html = '';
      if (iconUrl) html += `<img src="${iconUrl}" alt="" style="height:20px; width:20px; object-fit:contain; vertical-align:middle;">`;
      if (withSpin) html += `<span class="spin">‚è≥</span>`;
      html += `<span>${message}</span>`; toast.innerHTML = html;
      let cleanup;
      if (anchor) { const el = typeof anchor==='string' ? document.querySelector(anchor) : anchor; const rect = el?.getBoundingClientRect(); toast.classList.add('toast--anchored'); document.body.appendChild(toast); const top=(rect?.bottom??0)+offset; const left=(rect?rect.left+rect.width/2:window.innerWidth/2); toast.style.top=`${top}px`; toast.style.left=`${left}px`; toast.style.transform='translateX(-50%)'; cleanup=()=>toast.remove(); }
      else { const stack = getToastStack(position); stack.appendChild(toast); cleanup=()=>{ toast.remove(); if (!stack.children.length) stack.remove(); }; }
      requestAnimationFrame(()=>toast.classList.add('show'));
      const hide=()=>{ toast.classList.remove('show'); setTimeout(cleanup,250); };
      const timer=setTimeout(hide,duration); toast.addEventListener('click',()=>{ clearTimeout(timer); hide(); });
    }

    function showGroupList(config) {
      const modal = document.getElementById('modal'); const list = document.getElementById('modalList'); list.innerHTML = '';
      const apps = config.apps.filter(app => app.tags.includes(currentGroup));
      const backups = config.backups.filter(backup => backup.tags.includes(currentGroup));
      const links = (config.links || []).filter(link => link.tags.includes(currentGroup));
      if (apps.length===0 && backups.length===0 && links.length===0) list.innerHTML = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.';

      apps.forEach(app => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0');
        btn.textContent = app.file;
        btn.onclick = () => {
          showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ APK...<span class=\"spin\"><img src=\"https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(45).png\" style=\"height:29px; vertical-align:middle;\"></span>`, '#00cfff', 4000);
          window.AndroidInterface?.installSingle(app.url, app.file || '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
        };
        list.appendChild(btn);
      });

      backups.forEach(backup => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0');
        btn.textContent = backup.file;
        btn.onclick = () => {
          const urls = backup.urls || (backup.url ? [backup.url] : []); if (!urls.length) return;
          showStatus(`–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤... <span class=\"spin\"><img src=\"https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(45).png\" style=\"height:29px; vertical-align:middle;\"></span>`, '#00cfff', 4000);
          window.AndroidInterface?.copyMultipleBackups(JSON.stringify(urls), backup.target_folder);
        };
        list.appendChild(btn);
      });

      links.forEach(link => {
        const btn = document.createElement('button');
        btn.className = 'component-btn'; btn.setAttribute('tabindex','0');
        btn.textContent = link.file;
        btn.onclick = () => { showStatus('üîó –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...', 'green', 3000); window.AndroidInterface?.openLink(link.url); };
        list.appendChild(btn);
      });

      modal.setAttribute('aria-hidden','false');
      setTimeout(() => { const firstBtn = list.querySelector('.component-btn'); firstBtn?.focus(); }, 100);
    }

    function installAll() {
      showStatus(`–ù–∞—á–∞–ª–∞—Å—å –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ–∂–∏–¥–∞–π—Ç–µ...<span class=\"spin\"><img src=\"https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(45).png\" style=\"height:29px; vertical-align:middle;\"></span>`, '#00cfff', 4000);
      if (window.AndroidInterface) requestAnimationFrame(() => { setTimeout(() => { window.AndroidInterface.startInstallation(currentGroup); }, 100); });
    }

    function closeModal() { document.getElementById('modal').setAttribute('aria-hidden','true'); }

    // Enter –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –º–æ–¥–∞–ª–æ–∫ –Ω–µ—Ç)
    document.addEventListener('keydown', function(e){
      if (e.key !== 'Enter') return; if (anyModalOpen()) return;
      const active = document.activeElement;
      if (active && (active.textContent?.includes('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏') || active.textContent?.includes('–≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ'))) return;
      const selected = document.querySelector('.card.selected'); if (selected) startInstall();
    });

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    function handleBackButton() {
      if (document.getElementById('miscModal')?.getAttribute('aria-hidden') === 'false') closeMiscModal();
      else if (document.getElementById('autostartModal')?.getAttribute('aria-hidden') === 'false') closeAutostartModal();
      else if (document.getElementById('modal')?.getAttribute('aria-hidden') === 'false') closeModal();
      else window.AndroidInterface?.requestAppExit();
    }

    // –°–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É" –Ω–∞ –¢–í
    (function(){ const isTV = /TV|AFT|GoogleTV|SHIELD/i.test(navigator.userAgent); if (isTV) { const startBtn = document.getElementById('startBtn'); if (startBtn) startBtn.style.display='none'; } })();

    // –°–ø–ª—ç—à-—ç–∫—Ä–∞–Ω
    setTimeout(() => { document.getElementById('splash').style.display='none'; document.getElementById('main-content').style.display='block'; }, 3000);

    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä API
    function updateProgress(current = null, total = null, percent = 0, label) {
      const container = document.getElementById('progress-container'); const bar = document.getElementById('progress-bar'); const text = document.getElementById('progress-text');
      container.style.display = 'block'; bar.style.width = percent + '%';
      if (current !== null && total !== null) text.innerHTML = `–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:&nbsp;&nbsp; ${label ?? ''}&nbsp;&nbsp;&nbsp;&nbsp;${percent}%`;
      else text.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      if (percent >= 100 && (current === null || current === total)) setTimeout(() => { container.style.display='none'; bar.style.width='0%'; text.innerHTML=''; }, 1500);
    }
    function updateProgressWithLabel(current, total, percent, label) {
      const container = document.getElementById('progress-container'); const bar = document.getElementById('progress-bar'); const text = document.getElementById('progress-text');
      container.style.display = 'block'; bar.style.width = percent + '%'; text.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ ${label}: ${percent}%`;
      if (percent >= 100 && current === total) setTimeout(() => { container.style.display='none'; bar.style.width='0%'; text.innerText=''; }, 1500);
    }
    function hideProgress(){ const c=document.getElementById('progress-container'); const b=document.getElementById('progress-bar'); const t=document.getElementById('progress-text'); if(c) c.style.display='none'; if(b) b.style.width='0%'; if(t) t.innerText=''; }

    // ====== –ê–í–¢–û–ó–ê–ü–£–°–ö –ú–û–î–ê–õ–ö–ê ======
    function openAutostartModal() {
      lastFocusedElement = document.activeElement;
      const modal = document.getElementById('autostartModal'); const list = document.getElementById('autostartList');
      const current = document.getElementById('autostartCurrent'); current.innerHTML = '<span style="color: #00cfff;">–ë–µ–∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</span>';
      window.AndroidInterface?.getCurrentAutostartApp();
      modal.setAttribute('aria-hidden','false');
      list.innerHTML = '<div style="width:100%">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      window.AndroidInterface?.getUserApps();
      setTimeout(() => { const first = list.querySelector('.card, button'); if (first) first.focus(); else { modal.setAttribute('tabindex','-1'); modal.focus(); } }, 400);
    }
    function setCurrentAutostartApp(appLabel, appIcon) {
      const current = document.getElementById('autostartCurrent'); current.innerHTML = `<span style="font-weight:bold; color:#00cfff;">–ê–∫—Ç–∏–≤–Ω–æ–µ:</span> <img src="${appIcon}" alt="" style="height:24px; vertical-align:middle; margin:0 6px;"> <span style="font-weight:bold;">${appLabel}</span>`;
    }
    function closeAutostartModal() {
      document.getElementById('autostartModal').setAttribute('aria-hidden','true');
      if (lastFocusedElement && document.body.contains(lastFocusedElement)) lastFocusedElement.focus();
    }
    function renderAppSelection(json) {
      const apps = JSON.parse(json); const list = document.getElementById('autostartList'); list.innerHTML = '';
      apps.forEach(app => {
        const card = document.createElement('div'); card.className = 'card'; card.setAttribute('tabindex','0');
        card.innerHTML = `<img src="${app.icon}" alt="" style="height:24px;"><br>${app.label}`;
        card.onclick = (ev) => {
          ev.preventDefault(); ev.stopPropagation();
          window.AndroidInterface?.saveAutostartPackage(app.package);
          setCurrentAutostartApp(app.label, app.icon);
          showToast({ message: `${app.label} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫`, iconUrl: app.icon, type: 'success' });
        };
        card.onfocus = () => {
          document.querySelectorAll('#autostartList .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          // –î–æ–ø. —Å—Ç–∞—Ç—É—Å –ø–æ –∂–µ–ª–∞–Ω–∏—é
        };
        list.appendChild(card);
      });
      setTimeout(() => { list.querySelector('.card')?.focus(); }, 100);
    }
    function disableAutostart() {
      window.AndroidInterface?.DeleteAutostartPackage("");
      const current = document.getElementById('autostartCurrent'); current.innerHTML = '<span style="color:#00cfff;">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω</span>';
      showToast({ message: '–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω' });
    }

    // ====== –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–ö–ò –†–∞–∑–Ω–æ–µ ======
    function openMiscModal() {
      lastFocusedElement = document.activeElement; const modal = document.getElementById('miscModal');
      modal.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open');
      document.activeElement?.blur(); const firstBtn = modal.querySelector('.sys-btn');
      if (firstBtn) setTimeout(() => firstBtn.focus(), 100); else { modal.setAttribute('tabindex','-1'); modal.focus(); }
    }
    function closeMiscModal() {
      const modal = document.getElementById('miscModal'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open');
      setTimeout(() => { if (lastFocusedElement && document.body.contains(lastFocusedElement)) lastFocusedElement.focus?.(); lastFocusedElement = null; }, 50);
    }

    // ====== –ù–ê–í–ò–ì–ê–¶–ò–Ø –í #modal (—Ñ–∏–∫—Å ¬´–º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫¬ª) ======
    (function(){
      const container = document.getElementById('modalListContainer'); const list = document.getElementById('modalList'); if (!container || !list) return;
      const SELECTOR = '.component-btn';
      function buildRows(){ const items = Array.from(list.querySelectorAll(SELECTOR)).filter(el => !el.disabled && el.offsetParent !== null); const rows=[]; items.forEach(el=>{ const top=Math.round(el.offsetTop); let row = rows.find(r=>Math.abs(r.top-top)<=2); if(!row){ row={top,items:[]}; rows.push(row);} row.items.push(el); }); rows.sort((a,b)=>a.top-b.top); rows.forEach(r=>r.items.sort((a,b)=>a.offsetLeft-b.offsetLeft)); return rows; }
      function focusItem(el){ el?.focus({ preventScroll:true }); requestAnimationFrame(()=>{ el?.scrollIntoView({ block:'nearest', inline:'nearest' }); }); }
      function findRowCol(el, rows){ for(let ri=0; ri<rows.length; ri++){ const ci=rows[ri].items.indexOf(el); if(ci!==-1) return {ri,ci}; } return {ri:-1,ci:-1}; }
      let navLock=false; const NAV_DELAY=90;
      document.addEventListener('keydown', (e)=>{
        const modal = document.getElementById('modal'); if (!modal || modal.getAttribute('aria-hidden')!=='false') return;
        if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) return;
        const active = document.activeElement; if (!active || !active.closest('#modalList')) return;
        e.preventDefault(); e.stopPropagation(); if (navLock) return; navLock=true; setTimeout(()=>{navLock=false;}, NAV_DELAY);
        const rows = buildRows(); const {ri,ci} = findRowCol(active, rows); if (ri<0) return;
        let target=null; switch(e.key){
          case 'ArrowLeft': target = rows[ri].items[Math.max(ci-1,0)]; break;
          case 'ArrowRight': target = rows[ri].items[Math.min(ci+1, rows[ri].items.length-1)]; break;
          case 'ArrowUp': { const prevRow = rows[Math.max(ri-1,0)]; target = prevRow.items[Math.min(ci, prevRow.items.length-1)]; break; }
          case 'ArrowDown': { const nextRow = rows[Math.min(ri+1, rows.length-1)]; target = nextRow.items[Math.min(ci, nextRow.items.length-1)]; break; }
        }
        if (target && target!==active) focusItem(target);
      });
    })();

    // ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ autostartModal ======
    document.addEventListener('keydown', function(e){
      const modal = document.getElementById('autostartModal'); if (!modal || modal.getAttribute('aria-hidden')!=='false') return;
      const cards = Array.from(document.querySelectorAll('#autostartList .card')); const closeBtn = document.getElementById('autostartCloseBtn'); if (!cards.length) return;
      const cols=5; const active=document.activeElement; const index=cards.indexOf(active);
      if (active === closeBtn) {
        if (e.key==='ArrowUp'){ e.preventDefault(); cards[cards.length-1].focus(); }
        else if (e.key==='Back' || e.key==='Escape'){ e.preventDefault(); closeAutostartModal(); }
        return;
      }
      const total=cards.length; const row=Math.floor(index/cols); const col=index%cols;
      switch(e.key){
        case 'ArrowDown': e.preventDefault(); { const nextIndex=(row+1)*cols+col; if(nextIndex<total) cards[nextIndex].focus(); else closeBtn?.focus(); } break;
        case 'ArrowUp': e.preventDefault(); { const prevIndex=(row-1)*cols+col; if(prevIndex>=0) cards[prevIndex].focus(); } break;
        case 'ArrowLeft': e.preventDefault(); if(index>0) cards[index-1].focus(); break;
        case 'ArrowRight': e.preventDefault(); if(index<total-1) cards[index+1].focus(); break;
        case 'Enter': e.preventDefault(); active?.click(); break;
        case 'Back': case 'Escape': e.preventDefault(); closeAutostartModal(); break;
      }
    });

    // ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ miscModal (–ø—Ä–æ—Å—Ç–∞—è) ======
    document.addEventListener('keydown', function(e){
      const modal = document.getElementById('miscModal'); if (!modal || modal.getAttribute('aria-hidden')!=='false') return;
      if (e.key==='Back' || e.key==='Escape'){ e.preventDefault(); closeMiscModal(); }
    });
  </script>
</body>
</html>
