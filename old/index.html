<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; background-color: black; color: white; }
    select, input, button { font-size: 18px; padding: 10px; margin: 10px; width: 250px; }
    #status { margin-top: 20px; font-weight: bold; min-height: 24px; transition: opacity 0.5s ease; opacity: 0; position: fixed; top: 10px; left: 0; right: 0; text-align: center; z-index: 1001; }
    #status.visible { opacity: 1; }
    .spin { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    select:focus, input:focus, button:focus { outline: none; box-shadow: 0 0 8px red; border-color: red; }

    .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .card {
      background-color: #2a2a2a;
      border-radius: 16px;
      padding: 20px;
      width: 80px;
      height: 62px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white; font-size: 13px; border: 2px solid transparent; transition: all 0.2s ease; cursor: pointer;
    }
    .card:hover, .card:focus { background-color: #004d61; border-color: #00cfff; box-shadow: 0 0 10px rgba(0,0,0,0.5); outline: none; }
    .card.selected { background-color: #00cfff; color: black; border: 2px solid white; }

    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 999; outline: none; }
    .modal-content { background: #111; color: white; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; width: 80%; border: 1px solid #333; }
    #modalListContainer { max-height: 60vh; overflow-y: auto; margin-top: 10px; }
    #modalList { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; justify-items: center; }

    /* –°–¢–ò–õ–¨ –ö–ù–û–ü–û–ö –í –°–¢–ò–õ–ï GOOGLE TV */
    button {
      background-color: #004d61; color: white; border: 2px solid transparent; border-radius: 8px;
      padding: 10px 20px; font-size: 14px; width: 250px; cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      box-sizing: border-box;
    }
    button:hover { background-color: #00cfff; }
    button:focus { outline: none; border-color: white; box-shadow: 0 0 10px #004d61; }

    .system-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 12px; }
    .sys-btn {
      flex: 1 1 calc(33.33% - 20px); min-width: 100px; max-width: 240px;
      padding: 10px; font-size: 13px; text-align: center; background-color: #004d61; color: white;
      border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: background-color 0.3s ease;
    }
    .sys-btn:hover { background-color: #00cfff; }
    .sys-btn:focus { border-color: white; box-shadow: 0 0 10px #004d61; }

    #splash { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #000;
      display: flex; justify-content: center; align-items: center; z-index: 9999; }
    #logo { width: 300px; height: 300px;
      background: url('https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(8).svg') no-repeat center/contain;
      animation: flyInRotate 3s ease-out forwards; }
    @keyframes flyInRotate {
      0% { transform: scale(0.2) rotate(0deg); opacity: 0; }
      80% { transform: scale(1.2) rotate(1080deg); opacity: 1; }
      100% { transform: scale(1) rotate(1080deg); opacity: 1; }
    }
    body.modal-open { overflow: hidden; }
  </style>
</head>

<body style="margin: 0; padding: 0;">
  <div id="splash"><div id="logo"></div></div>
  <div id="main-content" style="display:none;"></div>

  <h5 style="margin-top: 0;">–ë—ã—Å—Ç—Ä—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ ATV –∏ GoogleTV! Filin4ik¬Æ_ATV.</h5>

  <div id="progress-container" style="display:none; width: 100%; background: #333; padding: 10px; z-index: 1002; position: fixed; top: 0; left: 0; right: 0;">
    <div id="progress-text" style="color: white; margin-bottom: 5px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div style="width: 100%; background: #000; height: 8px; border-radius: 6px;">
      <div id="progress-bar" style="height: 8px; width: 0%; background: #42A5F5; border-radius: 6px;"></div>
    </div>
  </div>

  <div class="card-container">
    <div class="card" data-group="1" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">üöÄ<br>–°—Ç–∞—Ä—Ç</div>
    <div class="card" data-group="2" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(4).svg" alt="YouTube" style="height: 20px;">YouTube
    </div>
    <div class="card" data-group="3" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">üé¨<br>–û–Ω–ª–∞–π–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä—ã</div>
    <div class="card" data-group="4" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(5).svg" alt="4_–¢–æ—Ä—Ä–µ–Ω—Ç" style="height: 20px;">–¢–æ—Ä—Ä–µ–Ω—Ç + –ö–∏–Ω–æ
    </div>
    <div class="card" data-group="5" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">üì∫<br>IPTV</div>
    <div class="card" data-group="6" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">üíæ<br>IPTV + TorrentTV</div>
    <div class="card" data-group="7" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">üíæ<br>–ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</div>
    <div class="card" data-group="8" tabindex="0" onclick="selectCard(this)" onfocus="selectCard(this)">‚úç<br>–ó–∞—è–≤–∫–∏</div>
  </div>

  <script>
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('focus', () => {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        currentGroup = card.dataset.group;
      });
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const selected = document.querySelector('.card.selected');
        if (selected) currentGroup = selected.dataset.group;
      }
    });
  </script>

  <select id="groupSelect" style="display:none;"></select>
  <button type="button" id="startBtn" onclick="startInstall()">–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É</button><br>

  <!-- –í–ê–ñ–ù–û: –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –±–µ–∑ –∞–≤—Ç–æ–ø–æ–¥—ä—ë–º–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã -->
  <input
    type="password"
    id="passwordInput"
    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
    autocomplete="off"
    inputmode="none"
    readonly
    tabindex="0"
  >

  <div id="status"></div>

  <!-- –ö–Ω–æ–ø–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div class="system-buttons">
    <button onclick="event.stopPropagation();window.AndroidInterface.openUnknownSources()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(8).svg" alt="" style="height: 18px;"><br>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAppSettingsList()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(42).png" alt="" style="height: 24px;"><br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAccessibilitySettings()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(44).png" alt="" style="height: 28px;"><br>–°–ø–µ—Ü –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openBatteryOptimization()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(34).png" alt="" style="height: 24px;"><br>–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAnydesk()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(12).svg" alt="" style="height: 24px;"><br>AnyDesk
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openPlayMarket()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(13).svg" alt="" style="height: 20px;"><br>Google Play
    </button>
    <button onclick="openAutostartModal()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(38).png" alt="" style="height: 28px;"><br>–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    </button>
    <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFileManagerPlus()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(15).svg" alt="" style="height: 26px;"><br>File Manager+
    </button>
    <button onclick="openMiscModal()" class="sys-btn">
      <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(19).png" alt="" style="height: 28px;"><br>–ü–æ–ª–µ–∑–Ω–æ–µ
    </button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ -->
  <div id="autostartModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div id="autostartCurrent" style="margin-bottom: 10px; font-weight: bold;">–í—ã–±—Ä–∞–Ω–æ: –ù–µ—Ç</div>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞:</h3>
      <button onclick="closeAutostartModal()" id="autostartCloseBtn">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
      <button onclick="disableAutostart()" class="sys-btn">üö´ –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫</button>
      <div id="autostartList" class="card-container"></div>
      <button onclick="closeAutostartModal()" id="autostartCloseBtn2">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–†–∞–∑–Ω–æ–µ¬ª -->
  <div id="miscModal" class="modal" style="display: none;" tabindex="-1">
    <div class="modal-content">
      <h3>–†–∞–∑–Ω–æ–µ</h3>
      <div class="system-buttons">
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openFilePicker()" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(15).svg" alt="" style="height: 26px;"><br>–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openSettingsForPackage('com.google.android.katniss')" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(6).svg" alt="" style="height: 24px;"><br>Google Katniss
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAllAppsSide()" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(11).svg" alt="" style="height: 24px;"><br>–ú–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.deleteCopiedBackups()" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(27).png" alt="" style="height: 28px;"><br>–£–¥–∞–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.clearWebCache()" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(20).png" alt="" style="height: 28px;"><br>–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.openAddAccountSettings()" class="sys-btn">
          <img src="https://raw.githubusercontent.com/F4IPTV/Play/main/Pictures/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20(40).png" alt="" style="height: 28px;"><br>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç
        </button>
        <button onclick="ignoreNextEnter=true;window.AndroidInterface.testAutostart()" class="sys-btn">üöÄ<br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞</button>
      </div>
      <br>
      <button onclick="closeMiscModal()" class="sys-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ì–ª–∞–≤–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:</h3>
      <div id="modalListContainer"><div id="modalList"></div></div>
      <br>
      <button onclick="installAll()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë</button>
    </div>
  </div>

  <script>
    let currentGroup = "";
    let cachedConfig = null;
    let lastPassword = ""; // –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ—Å—Ç–∞–≤–∏–ª –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

    // üîÅ –û—á–µ—Ä–µ–¥—å –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤
    let backupQueue = [];
    let backupTarget = "";

    // üîÅ –î–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ª–æ–∂–Ω–æ–≥–æ Enter
    let ignoreNextEnter = false;

    // Helper: –ø—Ä—è—á–µ–º IME –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º readonly –¥–ª—è –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
    function deactivatePasswordInput() {
      const input = document.getElementById('passwordInput');
      if (!input) return;
      if (!input.hasAttribute('readonly')) input.setAttribute('readonly','');
      if (window.AndroidInterface?.hideKeyboard) window.AndroidInterface.hideKeyboard();
    }

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –∞–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è –¢–í
    (function passwordImeControl() {
      const input = document.getElementById('passwordInput');

      function safeShowIme() {
        if (window.AndroidInterface?.showKeyboard) window.AndroidInterface.showKeyboard();
      }
      function safeHideIme() {
        if (window.AndroidInterface?.hideKeyboard) window.AndroidInterface.hideKeyboard();
      }

      function activatePasswordEditing() {
        if (input.hasAttribute('readonly')) {
          input.removeAttribute('readonly');
          input.focus();
          const len = input.value.length;
          try { input.setSelectionRange(len, len); } catch(e) {}
          safeShowIme();
        }
      }

      function deactivateEditing() {
        if (!input.hasAttribute('readonly')) input.setAttribute('readonly', '');
        safeHideIme();
        input.focus();
      }

      input.addEventListener('click', (e) => { e.preventDefault(); activatePasswordEditing(); });

      input.addEventListener('keydown', (e) => {
        const k = e.key;
        if (k === 'Enter' || k === 'OK' || k === ' ') {
          e.preventDefault();
          activatePasswordEditing();
          return;
        }
        if (k === 'Escape' || (k === 'Backspace' && input.value === '')) {
          e.preventDefault();
          deactivateEditing();
        }
      });

      input.addEventListener('blur', deactivateEditing);
      window.addEventListener('load', () => input.setAttribute('readonly',''));
    })();

    // –û—á–µ—Ä–µ–¥—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±—ç–∫–∞–ø–æ–≤
    function copyBackupsSequentially(urls, folder) {
      if (!urls.length) return;
      backupQueue = urls;
      backupTarget = folder;
      copyNextBackup();
    }

    function copyNextBackup() {
      if (backupQueue.length === 0) {
        showStatus("‚úÖ –í—Å–µ –±—ç–∫–∞–ø—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã", "green");
        return;
      }
      const url = backupQueue.shift();
      const fileName = url.split('/').pop();
      showStatus(`‚è≥ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ: ${fileName} <span class='spin'>‚è≥</span>`, "orange", 4000);
      if (window.AndroidInterface) window.AndroidInterface.copyBackup(url, backupTarget);
    }
    function onBackupCopied() { copyNextBackup(); }

    function selectCard(card) {
      const passwordInput = document.getElementById('passwordInput');
      passwordInput.blur();
      lastPassword = passwordInput.value.trim();
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      currentGroup = card.dataset.group;
      const st = document.getElementById('status');
      st.innerHTML = ""; st.classList.remove('visible');
    }

    // Enter –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É
    document.getElementById('passwordInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); startInstall(); }
    });

    async function startInstall() {
      const passwordInput = document.getElementById('passwordInput');
      passwordInput.blur(); // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
      const group = currentGroup;
      const password = document.getElementById('passwordInput').value.trim(); // <- –∞–∫—Ç—É–∞–ª—å–Ω–æ
      const status = document.getElementById('status');

      if (!group) {
        status.innerHTML = "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç.";
        status.style.color = "red"; status.classList.add('visible'); return;
      }

      try {
        const response = await fetch("https://f4iptv.github.io/Play/old/config.json");
        const config = await response.json();

        const groupInfo = config.groups[group];
        if (!groupInfo) {
          status.innerHTML = "‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!";
          status.style.color = "red"; status.classList.add('visible'); return;
        }

        if (groupInfo.password !== password) {
          status.innerHTML = "üîí –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
          status.style.color = "red"; status.classList.add('visible'); return;
        }

        cachedConfig = config;
        showGroupList(config);
      } catch (error) {
        status.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.";
        status.style.color = "red"; status.classList.add('visible');
      }
    }

    function showStatus(message, color, timeout = 4000) {
      const status = document.getElementById('status');
      status.innerHTML = message; status.style.color = color; status.classList.add('visible');
      clearTimeout(status.hideTimer);
      status.hideTimer = setTimeout(() => { status.classList.remove('visible'); }, timeout);
    }

    function showGroupList(config) {
      const modal = document.getElementById('modal');
      const list = document.getElementById('modalList');
      list.innerHTML = "";

      const apps = config.apps.filter(app => app.tags.includes(currentGroup));
      const backups = config.backups.filter(backup => backup.tags.includes(currentGroup));
      const links = config.links ? config.links.filter(link => link.tags.includes(currentGroup)) : [];

      if (apps.length === 0 && backups.length === 0 && links.length === 0) {
        list.innerHTML = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.";
      }

      apps.forEach(app => {
        const btn = document.createElement('button');
        btn.textContent = app.file;
        btn.onclick = () => {
          showStatus("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ APK... <span class='spin'>‚è≥</span>", "orange", 4000);
          if (window.AndroidInterface) window.AndroidInterface.installSingle(app.url, app.file || "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ");
        };
        list.appendChild(btn);
      });

      backups.forEach(backup => {
        const btn = document.createElement('button');
        btn.textContent = backup.file;
        btn.onclick = () => {
          const urls = backup.urls || (backup.url ? [backup.url] : []);
          if (!urls.length) return;
          showStatus("‚è≥ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤... <span class='spin'>‚è≥</span>", "orange", 4000);
          if (window.AndroidInterface) {
            window.AndroidInterface.copyMultipleBackups(JSON.stringify(urls), backup.target_folder);
          }
        };
        list.appendChild(btn);
      });

      links.forEach(link => {
        const btn = document.createElement('button');
        btn.textContent = link.file;
        btn.onclick = () => {
          showStatus("üîó –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...", "green", 3000);
          if (window.AndroidInterface) window.AndroidInterface.openLink(link.url);
        };
        list.appendChild(btn);
      });

      modal.style.display = "flex";
      setTimeout(() => { const firstBtn = list.querySelector('button'); if (firstBtn) firstBtn.focus(); }, 100);
    }

    function installAll() {
      showStatus("‚è≥ –ù–∞—á–∞–ª–∞—Å—å –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ–∂–∏–¥–∞–π—Ç–µ!!! <span class='spin'>‚è≥</span>", "orange", 4000);
      if (window.AndroidInterface) {
        requestAnimationFrame(() => { setTimeout(() => { window.AndroidInterface.startInstallation(currentGroup); }, 100); });
      }
    }

    function closeModal() {
      document.getElementById('modal').style.display = "none";
      deactivatePasswordInput();
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –º–æ–¥–∞–ª–∫–µ ¬´–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤¬ª
    document.addEventListener('keydown', function(e) {
      if (ignoreNextEnter) { ignoreNextEnter = false; return; }

      const modal = document.getElementById('modal');
      if (modal.style.display !== 'flex') return;

      const list = document.getElementById('modalList');
      const buttons = Array.from(list.querySelectorAll('button'));
      const extraButtons = Array.from(modal.querySelectorAll('.modal-content > button'));
      const allButtons = [...buttons, ...extraButtons];
      if (allButtons.length === 0) return;

      const cols = 2;
      const active = document.activeElement;
      const index = allButtons.indexOf(active);
      if (index === -1) { allButtons[0].focus(); return; }

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = index + cols;
        if (next < allButtons.length) allButtons[next].focus();
        else allButtons[allButtons.length - 1].focus();
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = index - cols;
        if (prev >= 0) allButtons[prev].focus();
        else buttons[buttons.length - 1]?.focus();
      }

      if (e.key === 'ArrowRight') { e.preventDefault(); if ((index % cols) < (cols - 1) && (index + 1) < allButtons.length) allButtons[index + 1].focus(); }
      if (e.key === 'ArrowLeft')  { e.preventDefault(); if ((index % cols) > 0) allButtons[index - 1].focus(); }

      if (e.key === 'Back' || e.key === 'Escape') { e.preventDefault(); closeModal(); }
    });

    // –ó–∞–ø—É—Å–∫ ¬´–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É¬ª –ø–æ Enter –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const active = document.activeElement;
        const modal = document.getElementById('modal');
        if (modal.style.display === 'flex') return;
        if (active && (active.textContent?.includes("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏") || active.textContent?.includes("–≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ"))) return;
        const selected = document.querySelector('.card.selected');
        if (selected) startInstall();
      }
    });

    // –û–±—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Back
    function handleBackButton() {
      if (document.getElementById('miscModal')?.style.display === 'flex') {
        closeMiscModal();
      } else if (document.getElementById('autostartModal')?.style.display === 'flex') {
        closeAutostartModal();
      } else if (document.getElementById('modal')?.style.display === 'flex') {
        closeModal();
      } else {
        window.AndroidInterface.requestAppExit();
      }
    }
    // –ï—Å–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—à—å –∞–ø–ø–∞—Ä–∞—Ç–Ω—É—é "Back" –≤ Kotlin ‚Äî –≤—ã–∑—ã–≤–∞–π –∏–∑ –Ω–µ—ë handleBackButton()

    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    function updateProgress(current = null, total = null, percent = 0, label) {
      const container = document.getElementById("progress-container");
      const bar = document.getElementById("progress-bar");
      const text = document.getElementById("progress-text");
      container.style.display = "block";
      bar.style.width = percent + "%";
      if (current !== null && total !== null) text.innerHTML = `–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:&nbsp;&nbsp; ${label}&nbsp;&nbsp;&nbsp;&nbsp;${percent}%`;
      else text.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞...`;
      if (percent >= 100 && (current === null || current === total)) {
        setTimeout(() => { container.style.display = "none"; bar.style.width = "0%"; text.innerHTML = ""; }, 1500);
      }
    }
    function updateProgressWithLabel(current, total, percent, label) {
      const container = document.getElementById("progress-container");
      const bar = document.getElementById("progress-bar");
      const text = document.getElementById("progress-text");
      container.style.display = "block";
      bar.style.width = percent + "%";
      text.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ ${label}: ${percent}%`;
      if (percent >= 100 && current === total) {
        setTimeout(() => { container.style.display = "none"; bar.style.width = "0%"; text.innerText = ""; }, 1500);
      }
    }

    // –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
    function openAutostartModal() {
      const modal = document.getElementById('autostartModal');
      const list = document.getElementById('autostartList');
      const current = document.getElementById('autostartCurrent');
      current.innerHTML = '<span style="color: gray;">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>';

      if (window.AndroidInterface) window.AndroidInterface.getCurrentAutostartApp();

      modal.style.display = 'flex';
      list.innerHTML = '<div style="grid-column: span 2;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';

      if (window.AndroidInterface) window.AndroidInterface.getUserApps();

      setTimeout(() => {
        const first = list.querySelector('.card, button');
        if (first) first.focus(); else { modal.setAttribute('tabindex', '-1'); modal.focus(); }
      }, 400);
    }

    function setCurrentAutostartApp(appLabel, appIcon) {
      const current = document.getElementById("autostartCurrent");
      current.innerHTML = `
        <span style="font-weight: bold; color: lightgreen;">–ê–∫—Ç–∏–≤–Ω–æ–µ:</span>
        <img src="${appIcon}" alt="" style="height: 24px; vertical-align: middle; margin: 0 6px;">
        <span style="font-weight: bold;">${appLabel}</span>
      `;
    }

    function closeAutostartModal() {
      document.getElementById('autostartModal').style.display = 'none';
      deactivatePasswordInput();
    }

    function renderAppSelection(json) {
      const apps = JSON.parse(json);
      const list = document.getElementById('autostartList');
      list.innerHTML = '';

      apps.forEach(app => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('tabindex', '0');
        card.innerHTML = `<img src="${app.icon}" alt="" style="height:24px;"><br>${app.label}`;
        card.onclick = () => {
          window.AndroidInterface.saveAutostartPackage(app.package);
          setCurrentAutostartApp(app.label, app.icon);
          showStatus(`‚úÖ ${app.label} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫`, 'green', 3000);
        };
        card.onfocus = () => {
          document.querySelectorAll('#autostartList .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          document.getElementById("autostartCurrent").textContent = "–í—ã–±—Ä–∞–Ω–æ: " + app.label; // —Ñ–∏–∫—Å: app.label
        };
        list.appendChild(card);
      });

      setTimeout(() => { const first = list.querySelector('.card'); if (first) first.focus(); }, 100);
    }

    function disableAutostart() {
      if (window.AndroidInterface) {
        window.AndroidInterface.DeleteAutostartPackage("");
        const current = document.getElementById('autostartCurrent');
        if (current) current.innerHTML = '<span style="color: gray;">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span>';
        showStatus("üö´ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω", "orange", 3000);
      }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫-–º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', function (e) {
      const modal = document.getElementById('autostartModal');
      if (!modal || modal.style.display !== 'flex') return;

      const cards = Array.from(document.querySelectorAll('#autostartList .card'));
      const closeBtn = document.getElementById('autostartCloseBtn2') || document.getElementById('autostartCloseBtn');
      if (!cards.length) return;

      const cols = 5;
      const active = document.activeElement;
      const index = cards.indexOf(active);

      if (active === closeBtn) {
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          cards[cards.length - 1].focus();
        } else if (e.key === 'Back' || e.key === 'Escape') {
          e.preventDefault();
          closeAutostartModal();
        }
        return;
      }

      const total = cards.length;
      const row = Math.floor(index / cols);
      const col = index % cols;

      switch (e.key) {
        case 'ArrowDown': {
          e.preventDefault();
          const nextIndex = (row + 1) * cols + col;
          if (nextIndex < total) cards[nextIndex].focus();
          else closeBtn?.focus();
          break;
        }
        case 'ArrowUp': {
          e.preventDefault();
          const prevIndex = (row - 1) * cols + col;
          if (prevIndex >= 0) cards[prevIndex].focus();
          break;
        }
        case 'ArrowLeft': e.preventDefault(); if (index > 0) cards[index - 1].focus(); break;
        case 'ArrowRight': e.preventDefault(); if (index < total - 1) cards[index + 1].focus(); break;
        case 'Enter': e.preventDefault(); active?.click(); break;
        case 'Back':
        case 'Escape': e.preventDefault(); closeAutostartModal(); break;
      }
    });

    // –ú–æ–¥–∞–ª–∫–∞ ¬´–†–∞–∑–Ω–æ–µ¬ª
    function openMiscModal() {
      const modal = document.getElementById("miscModal");
      modal.style.display = "flex";
      document.body.classList.add("modal-open");
      document.activeElement?.blur();
      const firstBtn = modal.querySelector('.sys-btn');
      if (firstBtn) setTimeout(() => firstBtn.focus(), 100); else { modal.setAttribute('tabindex','-1'); modal.focus(); }
    }
    function closeMiscModal() {
      const modal = document.getElementById("miscModal");
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
      deactivatePasswordInput();
    }

    // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ)
    function hideProgress() {
      const container = document.getElementById('progress-container');
      const bar = document.getElementById('progress-bar');
      const text = document.getElementById('progress-text');
      if (container) container.style.display = 'none';
      if (bar) bar.style.width = '0%';
      if (text) text.innerText = '';
    }

    function onInstalledAppsReceived(appsJson) {
      const container = document.getElementById('appList');
      if (!container) return;
      container.innerHTML = '';
      let apps;
      try { apps = JSON.parse(appsJson); } catch (e) { container.innerHTML = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.'; return; }
      apps.forEach(app => {
        const btn = document.createElement('button');
        btn.textContent = `${app.name} (${app.package})`;
        btn.onclick = () => {
          window.AndroidInterface.setAutostartPackage(app.package);
          alert("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: " + app.name);
          closeAutostartModal();
        };
        container.appendChild(btn);
        container.appendChild(document.createElement('br'));
      });
    }

    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    document.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("focus", () => {
        if (!btn.classList.contains("card")) document.querySelectorAll(".card").forEach(c => c.classList.remove("selected"));
      });
    });

    // Splash ‚Üí main
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }, 3000);

    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É" –Ω–∞ Android TV / Google TV
    const isTV = /TV|AFT|GoogleTV|SHIELD/i.test(navigator.userAgent);
    if (isTV) { const startBtn = document.getElementById("startBtn"); if (startBtn) startBtn.style.display = "none"; }
  </script>
</body>
</html>
